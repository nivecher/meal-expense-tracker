---
repos:
  # 1. File validation
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: check-yaml
        types: [yaml]
        args: [--unsafe]
      - id: check-json
      - id: check-toml
      - id: check-xml
      - id: check-merge-conflict

  # 2. Conventional commit message (commit-msg) â€“ commitlint
  # Uses project node_modules so @commitlint/config-conventional is found. Run npm install first.
  - repo: local
    hooks:
      - id: commitlint
        name: commitlint
        entry: >
          sh -c 'if [ -f node_modules/.bin/commitlint ]; then
            exec node_modules/.bin/commitlint --edit "$@";
          else
            echo "Commitlint deps missing. Run: npm install";
            exit 1;
          fi' sh
        language: system
        stages: [commit-msg]
        pass_filenames: true

  # 3. Formatting
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: end-of-file-fixer
      - id: trailing-whitespace
        exclude: .*\.(md|mdx|txt|toml|json|yaml|yml)$

  # 4. Security checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: detect-private-key
      - id: check-added-large-files

  # 5. Debug checks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: debug-statements

  # Python lint + format: Ruff (fix) then Black (format). Single hook, fixed order to avoid thrashing.
  # Matches make format-python: ruff check --fix then black. Run only when Python files change.
  - repo: local
    hooks:
      - id: python-lint
        name: ruff + black
        entry: >
          bash -c 'REPO="$(git rev-parse --show-toplevel)" && cd "$REPO" &&
          if [ -f "./venv/bin/python3" ]; then PYTHON=./venv/bin/python3;
          elif command -v python3 >/dev/null 2>&1; then PYTHON=python3;
          else echo "No Python found"; exit 1; fi &&
          $PYTHON -m ruff check --fix app tests migrations &&
          $PYTHON -m black app tests migrations'
        language: system
        files: \.py$

  # Security scanning
  - repo: https://github.com/PyCQA/bandit
    rev: 1.9.3
    hooks:
      - id: bandit
        args: [-c, .bandit, -r]
        files: ^app/
        exclude: (tests/|venv/|.venv/|migrations/)

  # Type checking with mypy - fast incremental check on changed files only
  # Full check runs in CI for comprehensive coverage
  - repo: local
    hooks:
      - id: mypy
        name: mypy
        entry: >
          bash -c 'REPO_ROOT="$(git rev-parse --show-toplevel)";
          cd "$REPO_ROOT" && export PYTHONPATH=. &&
          if [ -f "./venv/bin/python3" ]; then
            PYTHON="./venv/bin/python3";
          elif command -v python3 >/dev/null 2>&1; then
            PYTHON="python3";
          else
            echo "Skipping mypy - Python not found";
            exit 0;
          fi
          # Get changed Python files (staged + unstaged for pre-commit)
          CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "^app/.*\.py$" || true);
          if [ -z "$CHANGED_FILES" ]; then
            echo "No Python files changed, skipping mypy";
            exit 0;
          fi
          # Run mypy on changed files with incremental mode
          echo "Running mypy on changed files: $CHANGED_FILES";
          $PYTHON -m mypy $CHANGED_FILES --config-file=pyproject.toml --incremental'
        language: system
        files: ^app/.*\.py$
        exclude: ^(tests/|migrations/|venv/|.venv/)
        require_serial: true
        pass_filenames: true

  # Markdown linting (pinned to v0.38.0 for Node.js 18 compatibility)
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.47.0
    hooks:
      - id: markdownlint
        args:
          - --config=.markdownlint.json

  # Prettier for Markdown/JSON/YAML (auto-formats on commit)
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        additional_dependencies:
          - prettier@3.3.3
        files: \.(md|json|ya?ml)$

  # HTML linting with prettier (matches make lint-html)
  # Uses npm script to ensure consistency with make lint
  - repo: local
    hooks:
      - id: prettier-html
        name: prettier-html
        entry: >
          sh -c 'if [ -d node_modules ] && command -v npm >/dev/null 2>&1; then
            OUTPUT=$(npm run lint-html 2>&1);
            EXIT_CODE=$?;
            echo "$OUTPUT" | grep -v "unchanged" || true;
            exit $EXIT_CODE;
          else
            echo Skipping prettier-html;
            exit 0;
          fi'
        language: system
        types: [html]
        files: ^app/templates/.*\.html$
        require_serial: true

  # CSS linting with stylelint (matches make lint-css)
  # Uses npm script to ensure consistency with make lint
  - repo: local
    hooks:
      - id: stylelint
        name: stylelint
        entry: >
          sh -c 'if [ -d node_modules ] && command -v npm >/dev/null 2>&1; then
            npm run lint:css;
          else
            echo Skipping stylelint;
            exit 0;
          fi'
        language: system
        types: [css]
        files: ^app/static/css/.*\.css$
        require_serial: true

  # JavaScript linting with eslint (fix then lint; matches make lint-js)
  # Runs format:js (--fix) then lint:js so fixable issues are resolved before verify
  - repo: local
    hooks:
      - id: eslint
        name: eslint
        entry: >
          sh -c 'if [ -d node_modules ] && command -v npm >/dev/null 2>&1; then
            npm run format:js && npm run lint:js;
          else
            echo Skipping eslint;
            exit 0;
          fi'
        language: system
        files: ^app/static/js/.*\.js$
        require_serial: true

  # Terraform formatting
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.105.0
    hooks:
      - id: terraform_fmt
