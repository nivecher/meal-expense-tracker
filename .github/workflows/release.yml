---
name: Release

on:
  push:
    tags:
      - v*
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to release (e.g. v1.0.0). Omit to use latest vX.Y.Z on main.
        required: false
        type: string
      environment:
        description: Environment to deploy to
        required: true
        default: staging
        type: choice
        options:
          - staging
          - prod

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  APP_NAME: meal-expense-tracker
  PYTHON_VERSION: 3.13
  NODE_VERSION: 22
  AWS_REGION: us-east-1

jobs:
  validate-tag:
    name: Validate Release Tag
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.parse.outputs.version }}
      is_prerelease: ${{ steps.parse.outputs.is_prerelease }}
      release_tag: ${{ steps.resolve.outputs.release_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Resolve release tag
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            RELEASE_TAG="${{ github.ref_name }}"
            echo "Using tag from push: ${RELEASE_TAG}"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            RELEASE_TAG="${{ github.event.inputs.tag }}"
            echo "Using provided tag: ${RELEASE_TAG}"
          else
            git fetch --tags origin main
            git checkout main
            RELEASE_TAG=$(
              git tag --merged main --list 'v[0-9]*.[0-9]*.[0-9]*' --sort=-v:refname \
                | head -1
            )
            if [ -z "${RELEASE_TAG}" ]; then
              echo "No vX.Y.Z tag found on main"
              exit 1
            fi
            echo "Using latest semver tag on main: ${RELEASE_TAG}"
          fi
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
          echo "Resolved release_tag=${RELEASE_TAG}"

      - name: Parse version from tag
        id: parse
        run: |
          TAG="${{ steps.resolve.outputs.release_tag }}"
          VERSION=$(echo "$TAG" | sed 's/^v//')
          if [ -z "$VERSION" ]; then
            echo "Invalid tag format"
            exit 1
          fi
          if [[ "$VERSION" == *-alpha* || "$VERSION" == *-beta* || "$VERSION" == *-rc* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

  verify-image:
    name: Verify Image Exists
    needs: validate-tag
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify image exists
        run: |
          IMG="ghcr.io/${{ github.repository }}:${{ needs.validate-tag.outputs.version }}"
          docker manifest inspect "${IMG}" || {
            echo "Image not found: ${IMG}"
            exit 1
          }
          echo "Image exists: ${IMG}"

  create-release:
    name: Create GitHub Release
    needs: [validate-tag, verify-image]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_url: ${{ steps.create_release.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0
          ref: ${{ needs.validate-tag.outputs.release_tag }}

      - name: Generate release notes
        id: release_notes
        run: |
          TAG="${{ needs.validate-tag.outputs.release_tag }}"
          VERSION="${{ needs.validate-tag.outputs.version }}"
          LAST_TAG=$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || echo "")
          NOTES_FILE=$(mktemp)
          {
            echo "## Release ${VERSION}"
            echo ""
            if [ -n "$LAST_TAG" ]; then
              echo "### Changes since ${LAST_TAG}"
              echo ""
              git log "${LAST_TAG}".."${TAG}" --pretty=format:'- %s (%h)' | head -50
            else
              echo "### Initial Release"
              git log "${TAG}" --pretty=format:'- %s (%h)' | head -20
            fi
            echo ""
            echo ""
            echo "### Artifacts"
            echo ""
            echo "- Docker Image: \`ghcr.io/${{ github.repository }}:${VERSION}\`"
          } > "$NOTES_FILE"
          cp "$NOTES_FILE" release_notes.md

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate-tag.outputs.release_tag }}
          name: Release ${{ needs.validate-tag.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.validate-tag.outputs.is_prerelease }}
          generate_release_notes: false

  trigger-staging-deploy:
    name: Trigger Staging Deploy
    needs: [validate-tag, create-release]
    if: github.event.inputs.environment == 'staging' || github.event.inputs.environment == '' || github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger Deploy workflow
        uses: actions/github-script@v7
        env:
          VERSION: ${{ needs.validate-tag.outputs.version }}
        with:
          script: |
            const version = process.env.VERSION;
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main',
              inputs: {
                environment: 'staging',
                image_tag: version,
              },
            });
            console.log(`Triggered deploy.yml: environment=staging, image_tag=${version}`);
