---
name: Test

on:
  workflow_run:
    workflows: [Deploy]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      deployment_url:
        description: Deployment URL to test against
        required: false
        type: string
      test_suite:
        description: Test suite to run
        required: false
        type: choice
        default: all
        options:
          - all
          - health
          - api
          - e2e

env:
  PYTHON_VERSION: 3.13
  NODE_VERSION: 22
  PYTHONPATH: ${{ github.workspace }}
  FLASK_ENV: test
  TESTING: true

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  check-deploy:
    name: Check Deploy Status
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      deploy_passed: >
        ${{ github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion == 'success' ||
        github.event_name == 'workflow_dispatch' }}
      deployment_url: ${{ steps.set_url.outputs.url }}
    steps:
      - name: Check deploy workflow status
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "❌ Deploy workflow did not succeed, skipping tests"
              exit 1
            fi
            echo "✅ Deploy workflow succeeded, proceeding with tests"
          else
            echo "✅ Manual trigger via workflow_dispatch"
          fi

      - name: Determine deployment URL
        id: set_url
        run: |
          if [ -n "${{ github.event.inputs.deployment_url }}" ]; then
            DEPLOYMENT_URL="${{ github.event.inputs.deployment_url }}"
          else
            DEPLOYMENT_URL="https://meals.dev.nivecher.com"
          fi
          
          echo "url=${DEPLOYMENT_URL}" >> $GITHUB_OUTPUT
          echo "Using deployment URL: ${DEPLOYMENT_URL}"

      - name: Add status summary
        run: |
          echo "## Deployment Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Deploy Passed: ${{ steps.set_url.outputs.deploy_passed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment URL: ${{ steps.set_url.outputs.url }}" >> $GITHUB_STEP_SUMMARY

  health-checks:
    name: Health Checks
    needs: check-deploy
    if: needs.check-deploy.outputs.deploy_passed == 'true' && (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'health' || github.event.inputs.test_suite == '')
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Health check endpoint
        env:
          BASE_URL: ${{ needs.check-deploy.outputs.deployment_url }}
        run: |
          echo "Testing health endpoint at: ${BASE_URL}/health"
          
          MAX_ATTEMPTS=10
          for i in $(seq 1 $MAX_ATTEMPTS); do
            if curl -f -s "${BASE_URL}/health" > /dev/null; then
              echo "✅ Health check passed on attempt ${i}"
              curl -s "${BASE_URL}/health" | jq '.' || echo "Response received (not JSON)"
              exit 0
            fi
            echo "Attempt ${i}/${MAX_ATTEMPTS} failed, retrying in 5 seconds..."
            sleep 5
          done
          
          echo "❌ Health check failed after ${MAX_ATTEMPTS} attempts"
          exit 1

      - name: Add health check summary
        if: always()
        run: |
          echo "## Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Endpoint: ${{ needs.check-deploy.outputs.deployment_url }}/health" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status == 'success' && '✅ Passed' || '❌ Failed' }}" >> $GITHUB_STEP_SUMMARY

  api-tests:
    name: API Integration Tests
    needs: check-deploy
    if: needs.check-deploy.outputs.deploy_passed == 'true' && (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'api' || github.event.inputs.test_suite == '')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          requirements-file: requirements-dev.txt

      - name: Run API integration tests
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.check-deploy.outputs.deployment_url }}
        run: |
          source venv/bin/activate
          pytest tests/integration/ \
            -v \
            --base-url="${BASE_URL}" \
            -m "not slow" \
            --junitxml=api-test-results.xml \
            || echo "⚠️  Some API tests failed"

      - name: Upload API test results
        if: always()
        uses: actions/upload-artifact@v4.6.0
        with:
          name: api-test-results
          path: api-test-results.xml
          retention-days: 30
          if-no-files-found: ignore

      - name: Add API test summary
        if: always()
        run: |
          echo "## API Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Base URL: ${{ needs.check-deploy.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
          if [ -f api-test-results.xml ]; then
            echo "- Results: ✅ Generated" >> $GITHUB_STEP_SUMMARY
          fi

  e2e-tests:
    name: E2E Tests
    needs: check-deploy
    if: needs.check-deploy.outputs.deploy_passed == 'true' && (github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == 'e2e' || github.event.inputs.test_suite == '')
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright tests
        continue-on-error: true
        env:
          BASE_URL: ${{ needs.check-deploy.outputs.deployment_url }}
        run: |
          BASE_URL="${BASE_URL}" npx playwright test \
            --project=chromium \
            --reporter=html \
            || echo "⚠️  Some E2E tests failed"

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4.6.0
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Add E2E test summary
        if: always()
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Browser: Chromium" >> $GITHUB_STEP_SUMMARY
          echo "- Base URL: ${{ needs.check-deploy.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
          if [ -d playwright-report ]; then
            echo "- Report: ✅ Generated" >> $GITHUB_STEP_SUMMARY
          fi

  test-summary:
    name: Test Summary
    needs: [health-checks, api-tests, e2e-tests]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
      checks: write
    outputs:
      tests_passed: ${{ steps.check_results.outputs.passed }}
    steps:
      - name: Check test results
        id: check_results
        run: |
          HEALTH_STATUS="${{ needs.health-checks.result }}"
          API_STATUS="${{ needs.api-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"
          
          echo "Health Checks: ${HEALTH_STATUS}"
          echo "API Tests: ${API_STATUS}"
          echo "E2E Tests: ${E2E_STATUS}"
          
          # Consider skipped as success (tests filtered by test_suite input)
          if [ "${HEALTH_STATUS}" != "success" ] && [ "${HEALTH_STATUS}" != "skipped" ]; then
            echo "❌ Health checks failed"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ "${API_STATUS}" != "success" ] && [ "${API_STATUS}" != "skipped" ]; then
            echo "❌ API tests failed"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          if [ "${E2E_STATUS}" != "success" ] && [ "${E2E_STATUS}" != "skipped" ]; then
            echo "❌ E2E tests failed"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "✅ All tests passed"
          echo "passed=true" >> $GITHUB_OUTPUT

      - name: Add final summary
        if: always()
        run: |
          echo "## Test Suite Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          HEALTH="${{ needs.health-checks.result }}"
          API="${{ needs.api-tests.result }}"
          E2E="${{ needs.e2e-tests.result }}"
          
          if [ "$HEALTH" = "success" ]; then
            echo "| Health Checks | ✅ |" >> $GITHUB_STEP_SUMMARY
          elif [ "$HEALTH" = "skipped" ]; then
            echo "| Health Checks | ⏭️ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Health Checks | ❌ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$API" = "success" ]; then
            echo "| API Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          elif [ "$API" = "skipped" ]; then
            echo "| API Tests | ⏭️ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| API Tests | ❌ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$E2E" = "success" ]; then
            echo "| E2E Tests | ✅ |" >> $GITHUB_STEP_SUMMARY
          elif [ "$E2E" = "skipped" ]; then
            echo "| E2E Tests | ⏭️ |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| E2E Tests | ❌ |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_results.outputs.passed }}" = "true" ]; then
            echo "### ✅ All Tests Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ❌ Some Tests Failed" >> $GITHUB_STEP_SUMMARY
          fi
