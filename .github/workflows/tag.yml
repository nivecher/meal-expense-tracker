---
name: Tag

on:
  workflow_run:
    workflows: [CI]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      force:
        description: Force tag creation even if no version bump needed
        required: false
        default: false
        type: boolean

# Concurrency control
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel tagging in progress

env:
  PYTHON_VERSION: 3.13
  PYTHONPATH: ${{ github.workspace }}

# Required permissions
permissions:
  contents: write  # Needed for creating tags and commits
  id-token: write

jobs:
  # Check CI workflow status
  check-ci:
    name: Check CI Status
    runs-on: ubuntu-latest
    outputs:
      ci_passed: ${{ steps.check.outputs.ci_passed }}
      commit_sha: ${{ steps.check.outputs.commit_sha }}
    steps:
      - name: Check CI workflow status
        id: check
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "CI workflow did not succeed, skipping tagging"
              echo "ci_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi
            echo "CI workflow succeeded, proceeding with tagging"
            echo "ci_passed=true" >> $GITHUB_OUTPUT
            echo "commit_sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
          else
            echo "Manual trigger via workflow_dispatch, proceeding with tagging"
            echo "ci_passed=true" >> $GITHUB_OUTPUT
            echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

  # Create version tag
  create-tag:
    name: Create Version Tag
    needs: check-ci
    if: needs.check-ci.outputs.ci_passed == 'true'
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_tag.outputs.version }}
      tag: ${{ steps.version_tag.outputs.tag }}
      bump_needed: ${{ steps.version_tag.outputs.bump_needed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ needs.check-ci.outputs.commit_sha || github.sha }}

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            requirements*.txt
            constraints.txt

      - name: Install python-semantic-release and setuptools-scm
        run: |
          python -m pip install --upgrade pip
          pip install python-semantic-release[all] setuptools-scm[toml]

      - name: Configure git for tagging
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine next version
        id: version_tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_TAG: ${{ github.event.inputs.force || 'false' }}
        run: |
          # Use the same script used locally for version determination
          # This ensures CI and local preview are always in sync
          git fetch --tags --force
          python scripts/determine_version.py | tee version_output.txt
          
          # Parse outputs from script
          NEXT_VERSION=$(grep "^NEXT_VERSION=" version_output.txt | cut -d= -f2)
          NEW_TAG=$(grep "^NEW_TAG=" version_output.txt | cut -d= -f2)
          BUMP_NEEDED=$(grep "^BUMP_NEEDED=" version_output.txt | cut -d= -f2)
          
          echo "✅ Next version: ${NEXT_VERSION}"
          echo "✅ New tag: ${NEW_TAG}"
          echo "✅ Bump needed: ${BUMP_NEEDED}"
          
          # If force is true, set bump_needed to true
          if [ "$FORCE_TAG" = "true" ] && [ "$BUMP_NEEDED" = "false" ]; then
            echo "⚠️  Force tag requested, will create tag even if no bump needed"
            BUMP_NEEDED="true"
          fi
          
          # Store outputs for GitHub Actions
          echo "version=${NEXT_VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${NEW_TAG}" >> $GITHUB_OUTPUT
          echo "bump_needed=${BUMP_NEEDED}" >> $GITHUB_OUTPUT

      - name: Create and push git tag
        if: steps.version_tag.outputs.bump_needed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version_tag.outputs.tag }}"
          VERSION="${{ steps.version_tag.outputs.version }}"
          
          if [ -z "$TAG" ] || [ -z "$VERSION" ]; then
            echo "❌ Error: Tag or version is empty"
            exit 1
          fi
          
          echo "Creating tag: ${TAG}"
          
          # Check if tag already exists (shouldn't, but be safe)
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "⚠️  Tag ${TAG} already exists locally, skipping creation"
          else
            # Create annotated tag
            git tag -a "${TAG}" -m "chore(release): ${VERSION} [skip ci]"
            echo "✅ Created tag: ${TAG}"
          fi
          
          # Push tag to remote
          echo "Pushing tag to remote..."
          git push origin "${TAG}" || {
            echo "⚠️  Failed to push tag, checking if it exists remotely..."
            if git ls-remote --tags origin | grep -q "refs/tags/${TAG}"; then
              echo "Tag ${TAG} already exists on remote, continuing..."
            else
              echo "❌ Failed to push tag ${TAG}"
              exit 1
            fi
          }
          
          echo "✅ Successfully pushed tag: ${TAG}"

      - name: Generate version file using setuptools-scm
        if: steps.version_tag.outputs.bump_needed == 'true'
        run: |
          # Now that the tag exists, use setuptools-scm to generate version from git tags
          # setuptools-scm automatically handles:
          # - Tagged commits: shows the tag version (e.g., 0.6.1)
          # - Post-tag commits: shows tag.postN.devM+hash.date (e.g., 0.6.1.post1.dev3+gabc123.d20251207)
          # - Local/branch changes: includes commit hash and date
          # Configuration is read from pyproject.toml automatically
          python -c "
          import setuptools_scm
          version = setuptools_scm.get_version(
            write_to='app/_version.py',
            write_to_template='\"\"\"Version and build information for the application.\"\"\"\n\n__version__ = \"{version}\"\n\n# Build timestamp - set at build time via environment variable\n# Format: ISO 8601 (YYYY-MM-DDTHH:MM:SS+00:00)\nimport os\n\n__build_timestamp__ = os.getenv(\"BUILD_TIMESTAMP\", \"Not set\")\n'
          )
          print(f'Generated version from git tag: {version}')
          "
          
          # Verify the version file was created
          if [ -f "app/_version.py" ]; then
            echo "Version file contents:"
            cat app/_version.py
          else
            echo "Warning: Version file app/_version.py was not created"
            exit 1
          fi

      - name: Commit version file
        if: steps.version_tag.outputs.bump_needed == 'true'
        run: |
          # Commit the generated version file if it changed
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          VERSION="${{ steps.version_tag.outputs.version }}"
          
          if [ -f "app/_version.py" ]; then
            if git diff --exit-code --quiet app/_version.py; then
              echo "Version file unchanged"
            else
              git add app/_version.py
              git commit -m "chore: update version to ${VERSION} [skip ci]" || \
                echo "No version changes to commit"
              git push origin HEAD:main || echo "Failed to push version file commit"
            fi
          else
            echo "Warning: Version file app/_version.py was not created"
          fi

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.version_tag.outputs.bump_needed }}" = "true" ]; then
            echo "## ✅ Tag Created Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** ${{ steps.version_tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** ${{ steps.version_tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Commit:** ${{ needs.check-ci.outputs.commit_sha || github.sha }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ℹ️  No Version Bump Needed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No version bump was needed based on commit messages." >> $GITHUB_STEP_SUMMARY
            echo "Current version: ${{ steps.version_tag.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          fi
