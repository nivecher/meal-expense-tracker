---
name: Terraform Validate

on:
  workflow_call:
    inputs:
      terraform_version:
        required: false
        type: string
        default: 1.13.5
      environment:
        required: false
        type: string
        default: dev
      run_plan:
        required: false
        type: boolean
        default: false
    outputs:
      validation_passed:
        description: Whether validation passed
        value: ${{ jobs.validate.outputs.passed }}

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    outputs:
      passed: ${{ steps.validate.outputs.passed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}
          terraform_wrapper: false

      - name: Setup Terraform plugin cache
        uses: actions/cache@v4
        with:
          path: ${{ runner.temp }}/.terraform.d/plugin-cache
          key: terraform-plugins-${{ inputs.terraform_version }}-${{ hashFiles('terraform/**/*.tf') }}
          restore-keys: |
            terraform-plugins-${{ inputs.terraform_version }}-
            terraform-plugins-

      - name: Terraform format check
        run: |
          if [ -d "terraform" ]; then
            terraform -chdir=terraform fmt -check -recursive || {
              echo "Terraform format check failed"
              exit 1
            }
          else
            echo "No terraform directory found, skipping format check"
          fi

      - name: Terraform validation (basic)
        id: validate
        env:
          TF_PLUGIN_CACHE_DIR: ${{ runner.temp }}/.terraform.d/plugin-cache
          TF_IN_AUTOMATION: 1
        run: |
          if [ -d "terraform" ]; then
            cd terraform
            terraform init -backend=false
            terraform validate || {
              echo "Terraform validation failed"
              echo "passed=false" >> $GITHUB_OUTPUT
              exit 1
            }
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "No terraform directory found, skipping validation"
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Configure AWS Credentials
        if: inputs.run_plan
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1
          role-session-name: GitHubActions-Terraform-${{ github.run_id }}
          role-duration-seconds: 3600

      - name: Generate backend.hcl files from templates
        if: inputs.run_plan
        env:
          AWS_REGION: us-east-1
        run: |
          if [ -d "terraform" ]; then
            AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
            echo "Using AWS Account ID: $AWS_ACCOUNT_ID"
            echo "Using AWS Region: $AWS_REGION"
            for ENV in dev staging prod; do
              TEMPLATE_FILE="terraform/environments/${ENV}/backend.hcl.template"
              OUTPUT_FILE="terraform/environments/${ENV}/backend.hcl"
              if [ -f "$TEMPLATE_FILE" ]; then
                echo "Generating $OUTPUT_FILE from template..."
                sed -e "s/\${AWS_ACCOUNT_ID}/$AWS_ACCOUNT_ID/g" \
                    -e "s/\${AWS_REGION}/$AWS_REGION/g" \
                    "$TEMPLATE_FILE" > "$OUTPUT_FILE"
                echo "âœ… Generated $OUTPUT_FILE"
              fi
            done
          fi

      - name: Terraform validation (with backend)
        if: inputs.run_plan
        env:
          TF_ENV: ${{ inputs.environment }}
          TF_PLUGIN_CACHE_DIR: ${{ runner.temp }}/.terraform.d/plugin-cache
          TF_IN_AUTOMATION: 1
        run: |
          if [ -d "terraform" ]; then
            cd terraform
            terraform init -reconfigure -backend-config=environments/${TF_ENV}/backend.hcl
            terraform validate || {
              echo "Terraform validation with backend failed"
              exit 1
            }
          fi

      - name: Terraform Plan
        if: inputs.run_plan
        env:
          TF_ENV: ${{ inputs.environment }}
          TF_PARALLELISM: 30
          TF_PLUGIN_CACHE_DIR: ${{ runner.temp }}/.terraform.d/plugin-cache
          TF_IN_AUTOMATION: 1
        run: |
          if [ -d "terraform" ]; then
            cd terraform
            terraform init -reconfigure -backend-config=environments/${TF_ENV}/backend.hcl
            terraform plan \
              -var-file=environments/${TF_ENV}/terraform.tfvars \
              -var="environment=${TF_ENV}" \
              -input=false \
              -lock=true \
              -parallelism=${TF_PARALLELISM}
          fi
