{% extends "base.html" %}
{% block title %}
    Search for Restaurants - Meal Expense Tracker
{% endblock title %}
{% block extra_css %}
    <style>
        .toast-container {
            z-index: 11;
        }
    </style>
{% endblock extra_css %}
{% block styles %}
    {{ super() }}
    <link rel="stylesheet"
          href="{{ url_for('static', filename='css/pages/restaurant-search.css') }}">
{% endblock styles %}
{% block content %}
    <!-- Add CSRF token meta tag for AJAX requests -->
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <div class="container mt-3">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1 class="h4 mb-0">
                        <i class="fas fa-search-location text-primary me-2"></i>Find Restaurants
                    </h1>
                    <a href="{{ url_for('restaurants.list_restaurants') }}"
                       class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Back to My Restaurants
                    </a>
                </div>
                <!-- Google Places Search Component -->
                <div id="google-places-search">
                    <!-- Search input will be inserted here by JavaScript -->
                    <div id="search-results" class="mt-4">
                        <!-- Search results will be inserted here -->
                    </div>
                    <!-- Loading indicator (initially hidden) -->
                    <div id="loading-indicator" class="text-center py-5 d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Searching for restaurants...</p>
                    </div>
                </div>
                <!-- Toast container for notifications -->
                <div id="toastContainer"
                     class="position-fixed bottom-0 end-0 p-3 toast-container">
                    <!-- Toasts will be inserted here by JavaScript -->
                </div>
                <!-- Hidden form for adding a restaurant -->
                <form id="add-restaurant-form"
                      method="post"
                      action="{{ url_for('restaurants.add_restaurant') }}"
                      class="d-none">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="name" id="restaurant-name">
                    <input type="hidden" name="address" id="restaurant-address">
                    <input type="hidden" name="city" id="restaurant-city">
                    <input type="hidden" name="state" id="restaurant-state">
                    <input type="hidden" name="postal_code" id="restaurant-postal-code">
                    <input type="hidden" name="country" id="restaurant-country">
                    <input type="hidden" name="phone" id="restaurant-phone">
                    <input type="hidden" name="website" id="restaurant-website">
                    <input type="hidden" name="google_place_id" id="restaurant-google-place-id">
                    <!-- Coordinates removed - would be looked up dynamically from Google Places API -->
                </form>
            </div>
        </div>
        <!-- Success Modal removed - using toasts for feedback instead -->
        <!-- Error Modal -->
        <div class="modal fade"
             id="errorModal"
             tabindex="-1"
             aria-labelledby="errorModalLabel"
             role="alertdialog">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h1 class="modal-title h5" id="errorModalLabel">Error</h1>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <div class="mb-3" aria-hidden="true">
                            <i class="fas fa-exclamation-circle fa-4x text-danger"></i>
                        </div>
                        <h2 class="h5">Error Adding Restaurant</h2>
                        <p class="mb-0" id="error-message">An error occurred while adding the restaurant.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-danger"
                                data-bs-dismiss="modal"
                                id="error-close-btn"
                                tabindex="-1">Close</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Restaurant Exists Modal -->
        <div class="modal fade"
             id="existingRestaurantModal"
             tabindex="-1"
             aria-labelledby="existingRestaurantModalLabel">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title" id="existingRestaurantModalLabel">Restaurant Exists</h5>
                        <button type="button"
                                class="btn-close"
                                data-bs-dismiss="modal"
                                aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-info-circle fa-4x text-warning"></i>
                        </div>
                        <h5>Restaurant Already in Your List</h5>
                        <p class="mb-0" id="existingRestaurantModalBody">This restaurant is already in your list.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button"
                                class="btn btn-outline-secondary"
                                data-bs-dismiss="modal">Continue Searching</button>
                        <a href="#" id="viewExistingRestaurantBtn" class="btn btn-warning">
                            <i class="fas fa-utensils me-1"></i> View Restaurant
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    {{ super() }}
    <script>
        // Initialize the Google Maps API key
        window.GOOGLE_MAPS_API_KEY = '{{ google_maps_api_key or "" }}';
    </script>
    <script type="module"
            src="{{ url_for('static', filename='js/pages/restaurant-places-search.js') }}"></script>
{% endblock scripts %}
