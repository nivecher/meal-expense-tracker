{% extends "base.html" %}
{% block title %}
    {{ 'Edit' if is_edit else 'Add New' }} Restaurant - Meal Expense Tracker
{% endblock title %}
{% block styles %}
    {{ super() }}
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
          rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
          rel="stylesheet" />
    <style>
        /* Form sections */
        .form-section {
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
            background: #fafbfc;
            border-radius: 8px;
            padding: 2rem;
            border: 1px solid #e9ecef;
        }

        /* Section headers with better spacing */
        .section-header {
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }

        .section-header h5 {
            margin-bottom: 0;
            color: #495057;
        }

        /* Horizontal rule styling */
        .section-divider {
            border: none;
            height: 2px;
            background: linear-gradient(to right, #e9ecef, #dee2e6, #e9ecef);
            margin: 2.5rem 0;
            border-radius: 1px;
        }

        /* Last section styling (form actions) */
        .form-section:last-child {
            background: transparent;
            border: none;
            padding: 0;
        }

        /* Loading indicator */
        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            padding: 0.5rem;
            background-color: #0d6efd;
            color: white;
            z-index: 1060;
            display: none;
        }

        /* Error container */
        #error-container {
            position: fixed;
            top: 0;
            right: 0;
            padding: 1rem;
            max-width: 400px;
            z-index: 1060;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        /* Form controls */
        .form-floating>label {
            padding: 1rem 0.75rem;
        }

        /* Button styling */
        .btn-outline-warning {
            border-color: #ffc107;
            color: #ffc107;
        }

        .btn-outline-warning:hover {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #000;
        }

        /* Input group button styling */
        .input-group .btn {
            border-left: 0;
        }

        .input-group .form-control:focus + .btn {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
    </style>
{% endblock styles %}
{% block content %}
    <!-- Breadcrumb Navigation -->
    {% set breadcrumb_items = [
            {'url': url_for('main.index'), 'title': 'Dashboard'},
            {'url': url_for('restaurants.list_restaurants'), 'title': 'Restaurants'},
            {'title': 'Edit Restaurant' if is_edit else 'Add Restaurant'}
        ] %}
    {% include 'includes/breadcrumb.html' %}
    <!-- Success/Error Messages -->
    <!-- Flash messages now handled by base template -->
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card shadow-sm">
                    <div class="card-header bg-white py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h1 class="h4 mb-0">
                                <i class="fas fa-utensils me-2 text-primary"></i>
                                {{ 'Edit' if is_edit else 'Add New' }} Restaurant
                            </h1>
                            <a href="{{ url_for('restaurants.list_restaurants') }}"
                               class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-arrow-left me-1"></i> Back to List
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search for Restaurant Section -->
                        <div class="form-section">
                            <div class="section-header">
                                <h5>
                                    <i class="fas fa-search me-2 text-primary"></i>Search for Restaurant
                                </h5>
                            </div>
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Start typing the restaurant's name to search with Google Places. Select a restaurant to automatically fill
                                in the details.
                            </div>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="restaurant-search" class="form-label">Restaurant Search</label>
                                    <input type="text"
                                           class="form-control"
                                           id="restaurant-search"
                                           placeholder="Start typing restaurant name for autocomplete..."
                                           autocomplete="off">
                                    <div id="restaurant-suggestions" class="mt-2"></div>
                                </div>
                            </div>
                        </div>

                        <hr class="section-divider">
                        <form method="post"
                              action="{{ url_for('restaurants.edit_restaurant', restaurant_id=restaurant.id) if is_edit and restaurant else url_for('restaurants.add_restaurant') }}"
                              enctype="multipart/form-data"
                              novalidate
                              id="restaurantForm">
                            {{ form.hidden_tag() }}
                            <!-- Hidden fields for Google Places data -->
                            <input type="hidden"
                                   id="google_place_id"
                                   name="google_place_id"
                                   value="{{ form.google_place_id.data or '' }}">
                            <!-- Coordinates removed - would be looked up dynamically from Google Places API -->
                            <!-- Restaurant Information Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5>
                                            <i class="fas fa-info-circle me-2 text-primary"></i>Restaurant Information
                                        </h5>
                                        <button type="button"
                                                class="btn btn-outline-primary btn-sm"
                                                id="validate-restaurant-btn"
                                                onclick="validateRestaurantData()"
                                                title="Validate restaurant information with Google Places"
                                                disabled>
                                            <i class="fas fa-check-circle me-1"></i> Validate
                                        </button>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="name" class="form-label">Restaurant Name *</label>
                                        {{ form.name(class_="form-control" + (" is-invalid" if form.name.errors else "") ,
                                        placeholder="Enter restaurant name") }}
                                        {% for error in form.name.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                    </div>
                                    <div class="col-md-3">
                                        <label for="type" class="form-label">Type</label>
                                        {{ form.type(class_="form-select" + (" is-invalid" if form.type.errors else "") ) }}
                                        {% for error in form.type.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                    </div>
                                    <!-- Price range removed - would be looked up dynamically from Google Places API -->
                                    <div class="col-md-6">
                                        <label for="cuisine" class="form-label">Cuisine</label>
                                        {{ form.cuisine(class_="form-control" + (" is-invalid" if form.cuisine.errors else "") ) }}
                                        {% for error in form.cuisine.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                    </div>
                                    <div class="col-md-3">
                                        <label for="service_level" class="form-label">Service Level</label>
                                        {{ form.service_level(class_="form-select" + (" is-invalid" if form.service_level.errors else "") ) }}
                                        {% for error in form.service_level.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                    </div>
                                    <div class="col-md-3">
                                        <label for="rating" class="form-label">Your Rating</label>
                                        {{ form.rating(class_="form-control" + (" is-invalid" if form.rating.errors else "") ) }}
                                        {% for error in form.rating.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                    </div>
                                    <div class="col-md-3">
                                        <label for="is_chain" class="form-label">Part of a chain</label>
                                        <div class="form-check form-switch mt-2">
                                            {{ form.is_chain(class_="form-check-input" + (" is-invalid" if form.is_chain.errors else "") ) }}
                                            {% for error in form.is_chain.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                        </div>
                                    </div>
                                    <div class="col-12 mt-3">
                                        <label for="description" class="form-label">Description</label>
                                        {{ form.description(class_="form-control" + (" is-invalid" if form.description.errors
                                                                                else "") , rows="3", placeholder="Brief description of the restaurant") }}
                                        {% for error in form.description.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                    </div>
                                </div>
                            </div>

                            <hr class="section-divider">

                            <!-- Contact Information Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h5>
                                        <i class="fas fa-address-card me-2 text-primary"></i>Contact Information
                                    </h5>
                                </div>
                                    <!-- Address Fields -->
                                    <div class="row g-3">
                                        <div class="col-md-8">
                                            <label for="address" class="form-label">Street Address</label>
                                            {{ form.address(class_="form-control" + (" is-invalid" if form.address.errors else "") ,
                                            id="address",
                                            placeholder="Street Address",
                                            autocomplete="off") }}
                                            <div id="address-error" class="text-danger small mt-1 d-none"></div>
                                            {% for error in form.address.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                        </div>
                                        <div id="address-suggestions" class="mt-2"></div>
                                        <div id="address-valid-indicator" class="mt-2 small"></div>
                                        <div class="col-md-6">
                                            <label for="city" class="form-label">City</label>
                                            {{ form.city(class_="form-control" + (" is-invalid" if form.city.errors else "") ,
                                            id="city",
                                            placeholder="City"
                                            ) }}
                                            {% for error in form.city.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                        </div>
                                        <div class="col-md-3">
                                            <label for="state" class="form-label">State/Province</label>
                                            {{ form.state(class_="form-control" + (" is-invalid" if form.state.errors else "") ,
                                            id="state",
                                            placeholder="State/Province"
                                            ) }}
                                            {% for error in form.state.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                        </div>
                                        <div class="col-md-3">
                                            <label for="postal_code" class="form-label">Postal Code</label>
                                            {{ form.postal_code(class_="form-control" + (" is-invalid" if
                                                                                        form.postal_code.errors else "") ,
                                            id="postal_code",
                                            placeholder="Postal code"
                                            ) }}
                                            {% for error in form.postal_code.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                        </div>
                                        <div class="col-md-6">
                                            <label for="country" class="form-label">Country</label>
                                            {{ form.country(class_="form-control" + (" is-invalid" if form.country.errors else
                                                                                        "") ,
                                            id="country",
                                            placeholder="Country"
                                            ) }}
                                            {% for error in form.country.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                        </div>
                                        <div class="col-md-6">
                                            <label for="phone" class="form-label">Phone Number</label>
                                            {{ form.phone(class_="form-control" + (" is-invalid" if form.phone.errors else "") ,
                                            placeholder="Phone number") }}
                                            {% for error in form.phone.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                        </div>
                                        <div class="col-12">
                                            <label for="website" class="form-label">Website</label>
                                            <div class="input-group">
                                                {{ form.website(class_="form-control" + (" is-invalid" if form.website.errors else
                                                                                            "") , placeholder="https://example.com", id="website") }}
                                                <button type="button"
                                                        class="btn btn-outline-secondary"
                                                        id="open-website-btn"
                                                        onclick="openWebsite()"
                                                        title="Open website in new tab"
                                                        disabled>
                                                    <i class="fas fa-external-link-alt"></i>
                                                </button>
                                            </div>
                                            {% for error in form.website.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                        </div>
                                        {% if form.google_place_id.data %}
                                            <div class="col-12 mt-3">
                                                <label class="form-label">Google Place ID</label>
                                                <div class="input-group">
                                                    <input type="text"
                                                           id="google_place_id_display"
                                                           name="google_place_id_display"
                                                           class="form-control bg-light"
                                                           value="{{ form.google_place_id.data }}"
                                                           readonly
                                                           aria-describedby="google-place-id-help">
                                                    <button class="btn btn-outline-secondary"
                                                            type="button"
                                                            onclick="navigator.clipboard.writeText('{{ form.google_place_id.data }}')"
                                                            data-bs-toggle="tooltip"
                                                            title="Copy to clipboard">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                <div class="form-text">Used for Google Maps integration (read-only)</div>
                                            </div>
                                            <div class="col-12 mt-2 d-flex justify-content-end gap-2">
                                                <button type="button"
                                                        class="btn btn-sm btn-outline-warning"
                                                        onclick="clearPlaceId()"
                                                        title="Clear Google Place ID">
                                                    <i class="fas fa-times me-1"></i> Clear Place ID
                                                </button>
                                                <a href="https://www.google.com/maps/place/?q=place_id:{{ form.google_place_id.data }}"
                                                   target="_blank"
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-map-marker-alt me-1"></i> View on Google Maps
                                                </a>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <hr class="section-divider">

                            <!-- Additional Information Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h5>
                                        <i class="fas fa-sticky-note me-2 text-primary"></i>Additional Information
                                    </h5>
                                </div>
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="notes" class="form-label">Notes</label>
                                            {{ form.notes(class_="form-control" + (" is-invalid" if form.notes.errors else "") , rows="3", placeholder="Additional notes about the restaurant") }}
                                            {% for error in form.notes.errors %}<div class="invalid-feedback">{{ error }}</div>{% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <hr class="section-divider">

                            <!-- Form Actions -->
                            <div class="d-flex justify-content-between mt-4 pt-3">
                                    <div>
                                        <a href="{{ url_for('restaurants.list_restaurants') }}"
                                           class="btn btn-outline-secondary">
                                            <i class="fas fa-arrow-left me-1"></i> Back to List
                                        </a>
                                    </div>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>
                                            {{ 'Update' if is_edit else 'Save' }} Restaurant
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Loading Indicator -->
            <div class="d-flex justify-content-center my-3 d-none"
                 id="loadingIndicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <!-- Error Container -->
            <div id="errorContainer" class="alert alert-danger d-none" role="alert"></div>
        </div>
    </div>

    <!-- Validation Confirmation Modal -->
    <div class="modal fade" id="validationModal" tabindex="-1" aria-labelledby="validationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="validationModalLabel">
                        <i class="fas fa-check-circle me-2 text-primary"></i>Restaurant Validation Results
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="validation-loading" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Validating...</span>
                        </div>
                        <p class="mt-2">Validating restaurant information with Google Places...</p>
                    </div>

                    <div id="validation-results" class="d-none">
                        <div id="validation-success" class="d-none">
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>Restaurant information validated successfully!</strong>
                            </div>
                            <div id="validation-mismatches" class="d-none">
                                <h6 class="text-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Mismatches Found
                                </h6>
                                <div id="mismatch-list" class="mb-3"></div>
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Would you like to update the form with the corrected information from Google Places?
                                </div>
                            </div>
                            <div id="validation-no-mismatches" class="d-none">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    No mismatches found. The restaurant information is accurate.
                                </div>
                            </div>
                        </div>

                        <div id="validation-error" class="d-none">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <strong>Validation failed:</strong>
                                <div id="validation-error-message"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary d-none" id="apply-fixes-btn" onclick="applyAddressFixes()">
                        <i class="fas fa-sync-alt me-1"></i> Apply Fixes
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block scripts %}
    {{ super() }}
    <!-- Google Maps API Configuration -->
    <div id="google-maps-config"
         data-api-key="{{ config.GOOGLE_MAPS_API_KEY or '' }}"
         class="hidden"></div>
    {% if config.GOOGLE_MAPS_API_KEY %}
        <!-- Load Google Maps script directly -->
        <script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=places&loading=async"
                async
                defer></script>
        <!-- Load simple restaurant autocomplete -->
        <script type="module"
                src="{{ url_for('static', filename='js/utils/restaurant-autocomplete.js') }}"></script>
    {% endif %}
    <!-- Load restaurant form module -->
    <script type="module"
            src="{{ url_for('static', filename='js/pages/restaurant-form.js') }}"></script>

    <!-- Form-specific JavaScript functions -->
    <script>
        // Function to open website in new tab
        function openWebsite() {
            const websiteField = document.getElementById('website');
            const websiteUrl = websiteField.value.trim();

            if (websiteUrl) {
                // Ensure URL has protocol
                let url = websiteUrl;
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                window.open(url, '_blank', 'noopener,noreferrer');
            }
        }

        // Function to clear Google Place ID
        function clearPlaceId() {
            if (confirm('Are you sure you want to clear the Google Place ID? This will remove the connection to Google Places.')) {
                // Clear the hidden field
                const hiddenField = document.getElementById('google_place_id');
                if (hiddenField) {
                    hiddenField.value = '';
                }

                // Clear the display field
                const displayField = document.getElementById('google_place_id_display');
                if (displayField) {
                    displayField.value = '';
                }

                // Hide the Google Place ID section
                const placeIdSection = displayField?.closest('.col-12');
                if (placeIdSection) {
                    placeIdSection.style.display = 'none';
                }

                // Hide the entire buttons section (including Clear Place ID and View on Google Maps buttons)
                const buttonsSection = placeIdSection?.nextElementSibling;
                if (buttonsSection) {
                    buttonsSection.style.display = 'none';
                }

                // Clear the search input
                const searchInput = document.getElementById('restaurant-search');
                if (searchInput) {
                    searchInput.value = '';
                }

                // Show success message
                showSuccessMessage('Google Place ID cleared successfully');
            }
        }

        // Function to show success message (simple implementation)
        function showSuccessMessage(message) {
            // Create a temporary alert
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 3000);
        }

        // Enable/disable website button based on input
        document.addEventListener('DOMContentLoaded', function() {
            const websiteField = document.getElementById('website');
            const websiteBtn = document.getElementById('open-website-btn');

            if (websiteField && websiteBtn) {
                // Check initial state
                updateWebsiteButton();

                // Update button state on input change
                websiteField.addEventListener('input', updateWebsiteButton);

                function updateWebsiteButton() {
                    const hasValue = websiteField.value.trim().length > 0;
                    websiteBtn.disabled = !hasValue;
                }
            }

            // Enable/disable validate button based on name and address input
            const nameField = document.getElementById('name');
            const addressField = document.getElementById('address');
            const validateBtn = document.getElementById('validate-restaurant-btn');

            if (nameField && addressField && validateBtn) {
                // Check initial state
                updateValidateButton();

                // Update button state on input change
                nameField.addEventListener('input', updateValidateButton);
                addressField.addEventListener('input', updateValidateButton);

                function updateValidateButton() {
                    const hasName = nameField.value.trim().length > 0;
                    const hasAddress = addressField.value.trim().length > 0;
                    validateBtn.disabled = !(hasName && hasAddress);
                }
            }
        });

        // Global variable to store validation results
        let validationData = null;

        // Function to validate restaurant data
        async function validateRestaurantData() {
            const addressField = document.getElementById('address');
            const restaurantName = document.getElementById('name').value.trim();
            const googlePlaceId = document.getElementById('google_place_id').value.trim();

            if (!addressField.value.trim()) {
                showErrorMessage('Please enter an address to validate');
                return;
            }

            if (!restaurantName) {
                showErrorMessage('Please enter a restaurant name to validate');
                return;
            }

            // Show modal and loading state
            const modal = new bootstrap.Modal(document.getElementById('validationModal'));
            modal.show();

            showValidationLoading();

            try {
                const response = await fetch('/api/restaurants/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        name: restaurantName,
                        address: addressField.value.trim(),
                        google_place_id: googlePlaceId || null
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                validationData = data;

                if (data.status === 'success') {
                    showValidationResults(data.data);
                } else {
                    showValidationError(data.message || 'Validation failed');
                }

            } catch (error) {
                console.error('Validation error:', error);
                showValidationError('Failed to validate address: ' + error.message);
            }
        }

        // Function to show validation loading state
        function showValidationLoading() {
            document.getElementById('validation-loading').classList.remove('d-none');
            document.getElementById('validation-results').classList.add('d-none');
            document.getElementById('apply-fixes-btn').classList.add('d-none');
        }

        // Function to show validation results
        function showValidationResults(validationData) {
            document.getElementById('validation-loading').classList.add('d-none');
            document.getElementById('validation-results').classList.remove('d-none');

            if (validationData.mismatches && validationData.mismatches.length > 0) {
                // Show mismatches
                document.getElementById('validation-success').classList.remove('d-none');
                document.getElementById('validation-mismatches').classList.remove('d-none');
                document.getElementById('validation-no-mismatches').classList.add('d-none');
                document.getElementById('validation-error').classList.add('d-none');

                // Display mismatches
                const mismatchList = document.getElementById('mismatch-list');
                mismatchList.innerHTML = '';

                validationData.mismatches.forEach(mismatch => {
                    const mismatchItem = document.createElement('div');
                    mismatchItem.className = 'alert alert-warning mb-2';
                    mismatchItem.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${mismatch}`;
                    mismatchList.appendChild(mismatchItem);
                });

                // Show apply fixes button
                document.getElementById('apply-fixes-btn').classList.remove('d-none');

            } else {
                // No mismatches
                document.getElementById('validation-success').classList.remove('d-none');
                document.getElementById('validation-mismatches').classList.add('d-none');
                document.getElementById('validation-no-mismatches').classList.remove('d-none');
                document.getElementById('validation-error').classList.add('d-none');
                document.getElementById('apply-fixes-btn').classList.add('d-none');
            }
        }

        // Function to show validation error
        function showValidationError(message) {
            document.getElementById('validation-loading').classList.add('d-none');
            document.getElementById('validation-results').classList.remove('d-none');
            document.getElementById('validation-success').classList.add('d-none');
            document.getElementById('validation-error').classList.remove('d-none');
            document.getElementById('apply-fixes-btn').classList.add('d-none');

            document.getElementById('validation-error-message').textContent = message;
        }

        // Function to apply address fixes
        function applyAddressFixes() {
            if (!validationData || !validationData.data || !validationData.data.fixes) {
                showErrorMessage('No fixes available to apply');
                return;
            }

            const fixes = validationData.data.fixes;

            // Apply fixes to form fields
            if (fixes.name) {
                document.getElementById('name').value = fixes.name;
            }

            if (fixes.address) {
                document.getElementById('address').value = fixes.address;
            }

            if (fixes.city) {
                document.getElementById('city').value = fixes.city;
            }

            if (fixes.state) {
                document.getElementById('state').value = fixes.state;
            }

            if (fixes.postal_code) {
                document.getElementById('postal_code').value = fixes.postal_code;
            }

            if (fixes.country) {
                document.getElementById('country').value = fixes.country;
            }

            if (fixes.phone) {
                document.getElementById('phone').value = fixes.phone;
            }

            if (fixes.website) {
                document.getElementById('website').value = fixes.website;
            }

            if (fixes.service_level) {
                document.getElementById('service_level').value = fixes.service_level;
            }

            // Update Google Place ID if provided
            if (fixes.google_place_id) {
                document.getElementById('google_place_id').value = fixes.google_place_id;
            }

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('validationModal'));
            modal.hide();

            // Show success message
            showSuccessMessage('Restaurant information updated successfully!');
        }

        // Function to get CSRF token
        function getCSRFToken() {
            const token = document.querySelector('meta[name="csrf-token"]');
            return token ? token.getAttribute('content') : '';
        }

        // Function to show error message
        function showErrorMessage(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.textContent = message;
            errorContainer.classList.remove('d-none');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorContainer.classList.add('d-none');
            }, 5000);
        }
    </script>
{% endblock scripts %}
