{% extends "base.html" %}

{% block title %}Profile{% endblock title %}

{% block head_extra %}
<link href="{{ url_for('static', filename='css/forms.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='css/tag-select.css') }}" rel="stylesheet">
<script src="{{ url_for('static', filename='js/components/timezone-detector.js') }}" defer></script>
<script src="{{ url_for('static', filename='js/components/avatar-picker.js') }}" defer></script>
    <!-- Profile page styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/profile.css') }}">
    <!-- Embedded styles removed - now using external CSS file -->
{% endblock head_extra %}

{% block scripts %}
    <!-- Tag Manager for modal functionality - load after modal HTML is in DOM -->
    <script src="{{ url_for('static', filename='js/components/tag-manager.js') }}"></script>
{% endblock scripts %}

{% block content %}
<div class="profile-container">
    <!-- Profile Header -->
    {% from 'macros/avatar_helpers.html' import user_avatar %}
    <div class="profile-header">
        <div class="profile-avatar-container">
            {{ user_avatar(current_user, size='xl', show_username=false, class='profile-avatar') }}
                                        <div class="avatar-upload-overlay" data-action="trigger-avatar-upload">
                <div class="avatar-upload-text">
                    <i class="fas fa-camera"></i><br>
                    Change Avatar
                </div>
            </div>
        </div>
        <h1 class="profile-display-name">{{ current_user.get_display_name() }}</h1>
        <p class="profile-username">@{{ current_user.username }}</p>
    </div>

        <!-- Profile Form -->
    <form method="POST" class="profile-form" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

        <!-- Hidden avatar URL input for form submission -->
        <input type="hidden" id="avatar-url-input" name="avatar_url" value="{{ current_user.avatar_url or '' }}">

        <!-- Avatar Selection -->
        <div class="form-section">
            <h2 class="form-section-title">
                <i class="fas fa-image me-2"></i>Avatar
            </h2>

            <div class="avatar-picker-section">
                <div class="avatar-picker-header">Choose your avatar:</div>
                <div id="avatar-picker-container">
                    <!-- Avatar options will be populated by JavaScript -->
                </div>

                <div class="avatar-upload-placeholder">
                    <i class="fas fa-cloud-upload-alt me-2"></i>
                    <strong>Coming Soon:</strong> Upload your own avatar image
                    <br><small class="text-muted">For now, choose from the selection above or use your initials</small>
                </div>
            </div>
        </div>

        <!-- Personal Information -->
        <div class="form-section">
            <h2 class="form-section-title">
                <i class="fas fa-user me-2"></i>Personal Information
            </h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="first_name" class="form-label">First Name</label>
                    <input
                        type="text"
                        id="first_name"
                        name="first_name"
                        class="form-control"
                        value="{{ current_user.first_name or '' }}"
                        maxlength="64"
                        placeholder="Enter your first name"
                    />
                </div>

                <div class="form-group">
                    <label for="last_name" class="form-label">Last Name</label>
                    <input
                        type="text"
                        id="last_name"
                        name="last_name"
                        class="form-control"
                        value="{{ current_user.last_name or '' }}"
                        maxlength="64"
                        placeholder="Enter your last name"
                    />
                </div>
            </div>

            <div class="form-group">
                <label for="display_name" class="form-label">Display Name</label>
                <input
                    type="text"
                    id="display_name"
                    name="display_name"
                    class="form-control"
                    value="{{ current_user.display_name or '' }}"
                    maxlength="128"
                    placeholder="How you'd like to be displayed (optional)"
                />
                <div class="char-counter">
                    <span id="display_name_count">{{ (current_user.display_name or '') | length }}</span>/128
                </div>
            </div>

            <div class="form-group">
                <label for="bio" class="form-label">Bio</label>
                <textarea
                    id="bio"
                    name="bio"
                    class="form-control"
                    maxlength="500"
                    placeholder="Tell us a bit about yourself (optional)"
                    rows="3"
                >{{ current_user.bio or '' }}</textarea>
                <div class="char-counter">
                    <span id="bio_count">{{ (current_user.bio or '') | length }}</span>/500
                </div>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="form-section">
            <h2 class="form-section-title">
                <i class="fas fa-address-book me-2"></i>Contact Information
            </h2>

            <div class="form-row">
                <div class="form-group">
                    <label for="email" class="form-label">Email Address</label>
                    <input
                        type="email"
                        id="email"
                        class="form-control"
                        value="{{ current_user.email }}"
                        disabled
                        title="Email cannot be changed here. Contact support if needed."
                    />
                    <small class="text-muted">Contact support to change your email address</small>
                </div>

                <div class="form-group">
                    <label for="phone" class="form-label">Phone Number</label>
                    <input
                        type="tel"
                        id="phone"
                        name="phone"
                        class="form-control"
                        value="{{ current_user.phone or '' }}"
                        maxlength="20"
                        placeholder="+1 (555) 123-4567"
                    />
                </div>
            </div>
        </div>

        <!-- Preferences -->
        <div class="form-section">
            <h2 class="form-section-title">
                <i class="fas fa-cog me-2"></i>Preferences
            </h2>

            <div class="form-group">
                <label for="timezone" class="form-label">Timezone</label>
                <div class="timezone-container">
                    <select id="timezone" name="timezone" class="form-control">
                        <optgroup label="Common Timezones">
                            {% for tz_id, tz_display in common_timezones %}
                            <option value="{{ tz_id }}"{% if user_timezone == tz_id %} selected{% endif %}>
                                {{ tz_display }}
                            </option>
                            {% endfor %}
                        </optgroup>
                        <optgroup label="All Timezones">
                            {% for tz_id, tz_display in all_timezones %}
                            {% set tz_in_common = common_timezones | selectattr('0', 'equalto', tz_id) | list %}
                            {% if not tz_in_common %}
                            <option value="{{ tz_id }}"{% if user_timezone == tz_id %} selected{% endif %}>
                                {{ tz_display }}
                            </option>
                            {% endif %}
                            {% endfor %}
                        </optgroup>
                    </select>
                    <button
                        type="button"
                        id="detect-timezone-btn"
                        class="btn btn-outline-primary btn-sm mt-2"
                                                        data-action="detect-timezone"
                    >
                        <i class="fas fa-location-dot me-1"></i>Auto-detect
                    </button>
                    <div id="timezone-detected" class="timezone-detection-result mt-2" style="display: none;"></div>
                </div>

                <!-- Current Time Sanity Check -->
                <div class="mt-3 p-3 bg-light rounded border">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas fa-clock text-primary me-2"></i>
                        <strong class="text-muted">Current Time Check</strong>
                    </div>
                    <div class="text-sm">
                        <div class="mb-1">
                            <span class="text-muted">Your current time:</span>
                            <span class="fw-bold text-dark">{{ current_time_user_tz }}</span>
                        </div>
                        <div class="mb-1">
                            <span class="text-muted">Timezone:</span>
                            <span class="fw-bold text-info">{{ timezone_display }}</span>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            This shows your current local time based on your timezone setting.
                            If this looks incorrect, please update your timezone above.
                        </small>
                    </div>
                </div>
            </div>

            <!-- Tag Management -->
            <div class="form-group">
                <label class="form-label">Tag Management</label>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#tagEditorModal">
                        <i class="fas fa-tags me-1"></i>Manage Tags
                    </button>
                    <small class="text-muted">Create, edit, and organize your custom tags</small>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{{ url_for('main.index') }}" class="btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>Cancel
            </a>
            <button type="submit" class="btn-primary">
                <i class="fas fa-save me-1"></i>Save Changes
            </button>
        </div>
    </form>
</div>

<!-- Include Tag Editor Modal -->
{% include 'components/tag_editor_modal.html' %}

    <!-- Profile page functionality -->
    <!-- Note: tag-manager.js is loaded in head_extra, so it's available here -->
    <script type="module" src="{{ url_for('static', filename='js/pages/profile.js') }}"></script>
{% endblock content %}
