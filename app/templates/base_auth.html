<!doctype html>
<html lang="en" data-bs-theme="auto">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content="Meal Expense Tracker - Track and manage your dining expenses" />
        <meta name="keywords" content="meal expense tracker, food budget, dining expenses, expense management" />
        <meta name="author" content="Meal Expense Tracker" />
        <meta name="csrf-token" content="{{ csrf_token() }}" />
        <title> {% block title %} {% endblock title %} - Meal Expense Tracker</title>
        <!-- Favicons -->
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="{{ url_for('static', filename='img/favicons/apple-touch-icon.png') }}" />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="{{ url_for('static', filename='img/favicons/favicon-32x32.png') }}" />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="{{ url_for('static', filename='img/favicons/favicon-16x16.png') }}" />
        <link rel="manifest" href="{{ url_for('static', filename='img/favicons/site.webmanifest') }}" />
        <link
            rel="mask-icon"
            href="{{ url_for('static', filename='img/favicons/safari-pinned-tab.svg') }}"
            color="#5bbad5" />
        <meta name="msapplication-TileColor" content="#da532c" />
        <!-- Theme color removed - causing compatibility warnings -->
        <!-- Additional theme-color for older browsers -->
        <meta name="msapplication-navbutton-color" content="#2c3e50" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <!-- Centralized Dependencies -->
        {% include 'includes/dependencies.html' %}
        <!-- Custom CSS -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}" />
        {% block styles %} {% endblock styles %}
    </head>
    <body class="d-flex flex-column min-vh-100">
        <main class="flex-grow-1">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %}
            <div class="flash-messages mb-0">
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    <div class="alert-message">{{ message }}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %} {% endwith %} {% block content %} {% endblock content %}
        </main>
        <footer class="footer mt-auto py-3 bg-light">
            <div class="container text-center">
                <span class="text-muted">Â© {{ now.year }} Meal Expense Tracker. All rights reserved.</span>
            </div>
        </footer>
        <!-- Custom JS -->
        <script src="{{ url_for('static', filename='js/main.js') }}" type="module"></script>
        <!-- Simple auth form handler -->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Add error logging that persists across redirects
                window.addEventListener("error", function (e) {
                    console.error("Global error:", e.error, e.filename, e.lineno);
                    localStorage.setItem(
                        "lastError",
                        JSON.stringify({
                            error: e.error?.toString(),
                            filename: e.filename,
                            lineno: e.lineno,
                            timestamp: new Date().toISOString(),
                        })
                    );
                });

                // Check for previous errors
                const lastError = localStorage.getItem("lastError");
                if (lastError) {
                    console.log("Previous error found:", lastError);
                    // Clear it after logging
                    localStorage.removeItem("lastError");
                }
                // Helper function to display validation errors
                function displayValidationErrors(form, errors) {
                    // Clear existing errors
                    form.querySelectorAll(".text-danger").forEach((el) => el.remove());
                    form.querySelectorAll(".is-invalid").forEach((el) => el.classList.remove("is-invalid"));

                    // Display new errors
                    for (const [fieldName, errorMessages] of Object.entries(errors)) {
                        const field = form.querySelector(`[name="${fieldName}"]`);
                        if (field) {
                            field.classList.add("is-invalid");
                            const errorDiv = document.createElement("div");
                            errorDiv.className = "text-danger mt-1";
                            errorDiv.textContent = Array.isArray(errorMessages) ? errorMessages[0] : errorMessages;
                            field.parentNode.appendChild(errorDiv);
                        }
                    }
                }

                // Helper function to show error message
                function showErrorMessage(message) {
                    // Remove existing alerts
                    document.querySelectorAll(".alert-danger").forEach((el) => el.remove());

                    // Create and show error alert
                    const alertDiv = document.createElement("div");
                    alertDiv.className = "alert alert-danger alert-dismissible fade show mt-3";
                    alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

                    // Find the form container and prepend the alert
                    const container = document.querySelector(".container") || document.body;
                    container.insertBefore(alertDiv, container.firstChild);
                }

                // Simple form submission handler for auth forms
                const authForms = document.querySelectorAll("#login-form, #register-form");

                authForms.forEach((form) => {
                    form.addEventListener("submit", async function (e) {
                        // Allow normal form submission for better reliability
                        return;

                        const submitBtn = form.querySelector('input[type="submit"], button[type="submit"]');
                        const originalText = submitBtn.value || submitBtn.textContent;

                        // Show loading state
                        submitBtn.disabled = true;
                        if (submitBtn.tagName === "INPUT") {
                            submitBtn.value = "Processing...";
                        } else {
                            submitBtn.textContent = "Processing...";
                        }

                        try {
                            const formData = new FormData(form);

                            // Include CSRF token only if available in form (local dev)
                            const csrfInput = form.querySelector('input[name="csrf_token"]');
                            if (csrfInput && csrfInput.value) {
                                formData.set("csrf_token", csrfInput.value);
                            } else {
                                // For Lambda deployment, add empty CSRF token to satisfy form validation
                                formData.set("csrf_token", "");
                            }

                            const url = form.action || window.location.pathname;

                            const response = await fetch(url, {
                                method: "POST",
                                body: formData,
                                headers: {
                                    "X-Requested-With": "XMLHttpRequest",
                                },
                            });

                            // Check response status

                            if (response.ok) {
                                // Check if it's a redirect (successful login/registration)
                                if (response.redirected || response.url !== window.location.href) {
                                    window.location.href = response.url;
                                    return;
                                }

                                // Try to parse as JSON for API responses
                                const contentType = response.headers.get("content-type");
                                if (contentType && contentType.includes("application/json")) {
                                    const data = await response.json();
                                    if (data.redirect) {
                                        window.location.href = data.redirect;
                                        return;
                                    }
                                    if (data.success) {
                                        window.location.reload();
                                        return;
                                    }
                                }

                                // For HTML responses, reload the page to show any messages
                                window.location.reload();
                            } else {
                                // Handle error responses
                                console.error("Response failed with status:", response.status);

                                const contentType = response.headers.get("content-type");
                                if (contentType && contentType.includes("application/json")) {
                                    try {
                                        const errorData = await response.json();
                                        console.error("Form validation errors:", errorData);

                                        // Display validation errors
                                        if (errorData.errors) {
                                            displayValidationErrors(form, errorData.errors);
                                        } else if (errorData.message) {
                                            showErrorMessage(errorData.message);
                                        }
                                        return;
                                    } catch (e) {
                                        console.error("Failed to parse error response:", e);
                                    }
                                }

                                console.error("Form submission failed:", response.status, response.statusText);
                                // Don't reload to preserve error info for debugging
                            }
                        } catch (error) {
                            console.error("Form submission error:", error);
                            alert("An error occurred. Please try again.");
                        } finally {
                            // Restore button state
                            submitBtn.disabled = false;
                            if (submitBtn.tagName === "INPUT") {
                                submitBtn.value = originalText;
                            } else {
                                submitBtn.textContent = originalText;
                            }
                        }
                    });
                });
            });
        </script>
        {% block scripts %} {% endblock scripts %}
    </body>
</html>
