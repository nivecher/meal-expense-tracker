{% extends "base.html" %} {% block title %}Google API Cost Monitoring{% endblock %} {% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-chart-line me-2"></i>Google API Cost Monitoring</h1>
                <div class="btn-group">
                    <button class="btn btn-outline-primary" onclick="refreshMetrics()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <button class="btn btn-outline-warning" onclick="resetMetrics()">
                        <i class="fas fa-trash-alt me-1"></i>Reset Metrics
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Metrics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total API Calls</h6>
                            <h3 id="total-calls">-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-api fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Cache Hit Rate</h6>
                            <h3 id="cache-hit-rate">-%</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-database fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Estimated Cost</h6>
                            <h3 id="estimated-cost">$-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Cost Savings</h6>
                            <h3 id="cost-savings">$-</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-piggy-bank fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Call Breakdown -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list me-2"></i>API Call Breakdown</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>API Type</th>
                                    <th>Calls</th>
                                    <th>Cost per Call</th>
                                    <th>Total Cost</th>
                                </tr>
                            </thead>
                            <tbody id="api-breakdown">
                                <tr>
                                    <td colspan="4" class="text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cache Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-cogs me-2"></i>Cache Configuration</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Search Cache TTL</h6>
                            <p id="search-cache-ttl">-</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Details Cache TTL</h6>
                            <p id="details-cache-ttl">-</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Search Field Mask</h6>
                            <p id="search-field-mask">-</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Details Field Mask</h6>
                            <p id="details-field-mask">-</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cost Optimization Tips -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-lightbulb me-2"></i>Cost Optimization Tips</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-check-circle text-success me-2"></i>Implemented</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>Optimized field masks</li>
                                <li
                                    ><i class="fas fa-check text-success me-2"></i>Reduced search limits (10
                                    results)</li
                                >
                                <li><i class="fas fa-check text-success me-2"></i>Request deduplication</li>
                                <li><i class="fas fa-check text-success me-2"></i>Database caching</li>
                                <li><i class="fas fa-check text-success me-2"></i>Frontend debouncing (500ms)</li>
                                <li><i class="fas fa-check text-success me-2"></i>Rate limiting (10/min)</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-clock text-warning me-2"></i>Potential Savings</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-arrow-up text-primary me-2"></i>Skip photos in search: 40-60%</li>
                                <li
                                    ><i class="fas fa-arrow-up text-primary me-2"></i>Reduce autocomplete frequency:
                                    30-50%</li
                                >
                                <li
                                    ><i class="fas fa-arrow-up text-primary me-2"></i>Implement smart caching:
                                    60-80%</li
                                >
                                <li><i class="fas fa-arrow-up text-primary me-2"></i>Batch API requests: 20-40%</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    async function refreshMetrics() {
        try {
            const response = await fetch("/api/cost-monitoring/google-places");
            const data = await response.json();

            if (data.status === "success") {
                updateMetrics(data.data);
            } else {
                console.error("Failed to fetch metrics:", data.message);
            }
        } catch (error) {
            console.error("Error fetching metrics:", error);
        }
    }

    function updateMetrics(metrics) {
        // Update main metrics
        document.getElementById("total-calls").textContent = metrics.api_calls.total;
        document.getElementById("cache-hit-rate").textContent = metrics.cache.hit_rate.toFixed(1) + "%";
        document.getElementById("estimated-cost").textContent = "$" + metrics.estimated_costs.total_usd.toFixed(4);
        document.getElementById("cost-savings").textContent = "$" + metrics.estimated_costs.saved_usd.toFixed(4);

        // Update API breakdown
        const breakdownTable = document.getElementById("api-breakdown");
        breakdownTable.innerHTML = "";

        Object.entries(metrics.estimated_costs.breakdown).forEach(([apiType, cost]) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${apiType}</td>
            <td>${metrics.api_calls[apiType] || 0}</td>
            <td>$${(cost / (metrics.api_calls[apiType] || 1)).toFixed(4)}</td>
            <td>$${cost.toFixed(4)}</td>
        `;
            breakdownTable.appendChild(row);
        });

        // Update cache configuration
        document.getElementById("search-cache-ttl").textContent =
            metrics.configuration.search_cache_ttl_seconds + " seconds";
        document.getElementById("details-cache-ttl").textContent =
            metrics.configuration.details_cache_ttl_seconds + " seconds";
        document.getElementById("search-field-mask").textContent = metrics.configuration.search_field_mask;
        document.getElementById("details-field-mask").textContent = metrics.configuration.details_field_mask;
    }

    async function resetMetrics() {
        if (confirm("Are you sure you want to reset all metrics? This action cannot be undone.")) {
            try {
                const response = await fetch("/api/cost-monitoring/google-places/reset-metrics", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                });

                if (response.ok) {
                    alert("Metrics reset successfully!");
                    refreshMetrics();
                } else {
                    alert("Failed to reset metrics");
                }
            } catch (error) {
                console.error("Error resetting metrics:", error);
                alert("Error resetting metrics");
            }
        }
    }

    // Load metrics on page load
    document.addEventListener("DOMContentLoaded", refreshMetrics);

    // Auto-refresh every 30 seconds
    setInterval(refreshMetrics, 30000);
</script>
{% endblock %}
