<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- Theme color removed - causing compatibility warnings -->
        <meta name="description" content="Track and manage your meal expenses with our easy-to-use expense tracker" />
        <meta name="keywords" content="meal expense tracker, food expenses, budget tracking, expense management" />
        <meta name="author" content="Meal Expense Tracker" />
        <meta name="csrf-token" content="{{ csrf_token() }}" />

        <!-- Unified Error Handler - MUST LOAD FIRST -->
        <script src="{{ url_for('static', filename='js/utils/unified-error-handler.js') }}"></script>

        <!-- Bootstrap Icons -->
        <title> {% block title %} Meal Expense Tracker {% endblock title %} </title>
        <!-- Favicon -->
        <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='img/favicons/favicon.ico') }}" />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="{{ url_for('static', filename='img/favicons/favicon-32x32.png') }}"
            width="32"
            height="32" />
        <link
            rel="icon"
            type="image/png"
            sizes="16x16"
            href="{{ url_for('static', filename='img/favicons/favicon-16x16.png') }}"
            width="16"
            height="16" />
        <link
            rel="apple-touch-icon"
            sizes="180x180"
            href="{{ url_for('static', filename='img/favicons/apple-touch-icon.png') }}"
            width="180"
            height="180" />
        <link rel="manifest" href="{{ url_for('static', filename='img/favicons/site.webmanifest') }}" />
        <!-- Centralized Dependencies -->
        {% include 'includes/dependencies.html' %}
        <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/main.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/components/navbar.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/components/search.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/components/badges.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/forms.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/utilities.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/loading.css') }}" rel="stylesheet" />
        <link href="{{ url_for('static', filename='css/select2-fixes.css') }}" rel="stylesheet" />
        <!-- Google Places CSS removed - not needed for direct API calls -->
        {% if config.DEBUG %}
        <script type="module" src="{{ url_for('static', filename='js/utils/debug.js') }}"></script>
        {% endif %}
        <!-- Moved to static/css/main.css -->
        {% block head_extra %} {% endblock head_extra %}
    </head>
    <body>
        {% include "includes/navbar.html" %}
        <main class="container py-4">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %} {% if messages %}
            <div class="flash-messages mb-4">
                {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    <div class="alert-message">{{ message }}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %} {% endwith %}
            <!-- Toast Container -->
            <div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"> </div>
            {% block content %} {% endblock content %}
        </main>
        <footer class="footer mt-5 py-4 bg-light">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="mb-0"> 2025 Meal Expense Tracker. All rights reserved. </p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="{{ url_for('main.about') }}" class="text-muted me-3" title="About Us">About</a>
                        <a href="{{ url_for('main.terms') }}" class="text-muted me-3" title="Terms of Service">Terms</a>
                        <a href="{{ url_for('main.privacy') }}" class="text-muted me-3" title="Privacy Policy"
                            >Privacy</a
                        >
                        <a href="{{ url_for('main.contact') }}" class="text-muted" title="Contact Us">Contact</a>
                    </div>
                </div>
            </div>
        </footer>
        <!-- Application Configuration -->
        <div
            id="app-config"
            data-app-config='{
                "staticBaseUrl": "{{ request.script_root or "" }}",
                "app": {
                    "debug": {{ "true" if config.DEBUG else "false" }},
                    "env": "{{ config.ENV or "production" }}",
                    "version": "{{ get_app_version() }}"
                },
                "googleMaps": {
                    "apiKey": "{{ config.GOOGLE_MAPS_API_KEY or "" }}"
                },
                "colors": {
                    "gray": "#6c757d",
                    "orange": "#fd7e14",
                    "green": "#198754",
                    "cyan": "#0dcaf0",
                    "red": "#dc3545",
                    "purple": "#6f42c1",
                    "blue": "#0d6efd"
                },
                "cuisines": {{ cuisine_names|tojson }},
                "mealTypes": {{ meal_types|tojson }}
            }'>
        </div>
        <!-- Unified Error Handler already loaded above -->

        <!-- Core Application Scripts -->
        <script type="module" src="{{ url_for('static', filename='js/utils/timezone-handler.js') }}" defer></script>
        <script type="module" src="{{ url_for('static', filename='js/utils/date-formatter.js') }}" defer></script>
        <script type="module" src="{{ url_for('static', filename='js/main.js') }}" defer></script>
        <script type="module" src="{{ url_for('static', filename='js/config.js') }}" defer></script>
        <!-- Load other utility modules -->
        <script type="module" src="{{ url_for('static', filename='js/utils/error-handler.js') }}" defer></script>
        <script type="module" src="{{ url_for('static', filename='js/utils/logger.js') }}" defer></script>
        <script type="module" src="{{ url_for('static', filename='js/utils/module-loader.js') }}" defer></script>
        <script type="module" src="{{ url_for('static', filename='js/utils/select2-init.js') }}" defer></script>
        {% if config.DEBUG %}
        <script type="module" src="{{ url_for('static', filename='js/utils/debug.js') }}" defer></script>
        <script type="module" src="{{ url_for('static', filename='js/utils/console-test.js') }}" defer></script>
        <!-- Console warning filter for development -->
        <script src="{{ url_for('static', filename='js/utils/console-filter.js') }}"></script>
        {% endif %}
        <!-- Page-specific scripts -->
        {% block scripts %} {% endblock scripts %} {% block extra_js %} {% endblock extra_js %}

        <!-- Initialize page modules -->
        <!-- Load configuration utility -->
        <!-- Table sort component -->
        <!-- <script type="module" src="{{ url_for('static', filename='js/components/table-sort.js') }}" defer></script> -->
        <script type="module" src="{{ url_for('static', filename='js/components/sticky-tables.js') }}" defer></script>
        <!-- Navbar components -->
        <script type="module" src="{{ url_for('static', filename='js/components/modern-avatar.js') }}" defer></script>
        <script type="module" src="{{ url_for('static', filename='js/components/navbar.js') }}" defer></script>

        <!-- Font Awesome fallback -->
        <script type="module" src="{{ url_for('static', filename='js/utils/fontawesome-fallback.js') }}"></script>
        <!-- Image fallback handling -->
        <link rel="stylesheet" href="{{ url_for('static', filename='css/components/image-fallback.css') }}" />
        <script type="module" src="{{ url_for('static', filename='js/components/image-fallback.js') }}"></script>

        <!-- Lazy loading optimizer -->
        <script type="module" src="{{ url_for('static', filename='js/utils/lazy-loading-optimizer.js') }}"></script>

        <!-- Robust favicon handling -->
        <script type="module" src="{{ url_for('static', filename='js/utils/robust-favicon-handler.js') }}"></script>

        <!-- Flash to Toast Converter -->
        <script type="module">
            import { toast } from "/static/js/utils/notifications.js";

            document.addEventListener("DOMContentLoaded", function () {
                // Convert flash messages to toasts only if they exist and no JavaScript toasts are expected
                const flashMessages = document.querySelectorAll(".flash-messages .alert");
                flashMessages.forEach(function (alert) {
                    // Only convert if this is a page load (not an AJAX response)
                    if (!alert.closest("[data-ajax-response]")) {
                        const message = alert.querySelector(".alert-message")?.innerHTML || alert.textContent.trim();
                        const category = alert.classList.contains("alert-success")
                            ? "success"
                            : alert.classList.contains("alert-danger")
                              ? "error"
                              : alert.classList.contains("alert-warning")
                                ? "warning"
                                : "info";

                        // Show toast
                        toast[category](message);

                        // Hide the original flash message
                        alert.style.display = "none";
                    }
                });
            });
        </script>
    </body>
</html>
