{% extends "base.html" %} {% block title %} Import Expenses {% endblock title %} {% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-white py-3">
                    <h2 class="h4 mb-0">Import Expenses</h2>
                </div>
                <div class="card-body">
                    <!-- Flash messages now handled by base template -->
                    <div class="mb-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <h3 class="h5 mb-0">Quick Start</h3>
                            <a
                                href="{{ url_for('expenses.export_expenses', format='csv', sample='true') }}"
                                class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-download me-1"></i>Sample CSV
                            </a>
                        </div>

                        <div class="alert alert-primary">
                            <i class="fas fa-upload me-2"></i>
                            <strong>Upload a CSV or JSON file with expense data.</strong>
                            Required: <code>date</code> and <code>amount</code> columns. Optional: restaurant, category,
                            meal type, notes, tags.
                        </div>

                        <!-- Expandable Sections -->
                        <div class="accordion" id="importAccordion">
                            <!-- Required Fields -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingRequired">
                                    <button
                                        class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseRequired"
                                        aria-expanded="false"
                                        aria-controls="collapseRequired">
                                        <i class="fas fa-asterisk text-danger me-2"></i>
                                        <strong>Required Fields</strong>
                                    </button>
                                </h2>
                                <div
                                    id="collapseRequired"
                                    class="accordion-collapse collapse"
                                    aria-labelledby="headingRequired"
                                    data-bs-parent="#importAccordion">
                                    <div class="accordion-body">
                                        <ul class="mb-0">
                                            <li
                                                ><code>date</code> - Expense date (YYYY-MM-DD, M/D/YYYY, Excel serial
                                                dates)</li
                                            >
                                            <li
                                                ><code>amount</code> - Amount (24.77, $24.77, (24.77) for expenses,
                                                +$24.77 for reimbursements)</li
                                            >
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Optional Fields -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingOptional">
                                    <button
                                        class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseOptional"
                                        aria-expanded="false"
                                        aria-controls="collapseOptional">
                                        <i class="fas fa-plus-circle text-success me-2"></i>
                                        <strong>Optional Fields</strong>
                                    </button>
                                </h2>
                                <div
                                    id="collapseOptional"
                                    class="accordion-collapse collapse"
                                    aria-labelledby="headingOptional"
                                    data-bs-parent="#importAccordion">
                                    <div class="accordion-body">
                                        <ul class="mb-0">
                                            <li
                                                ><code>restaurant_name</code> - Restaurant name (auto-creates if
                                                new)</li
                                            >
                                            <li><code>restaurant_address</code> - Address (prevents duplicates)</li>
                                            <li><code>time_utc</code> - Time (HH:MM or HH:MM:SS, stored as UTC)</li>
                                            <li
                                                ><code>datetime_utc</code> - Full UTC timestamp (ISO 8601, e.g.
                                                2025-01-15T12:00:00Z)</li
                                            >
                                            <li
                                                ><code>category_name</code> - Category ("Parent:Child" format
                                                supported)</li
                                            >
                                            <li><code>meal_type</code> - breakfast, lunch, dinner, snacks</li>
                                            <li><code>order_type</code> - dine_in, takeout, delivery, etc.</li>
                                            <li><code>party_size</code> - Number of people (1-50)</li>
                                            <li><code>notes</code> - Additional details</li>
                                            <li><code>tags</code> - Comma-separated tag names (auto-created)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Smart Features -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingFeatures">
                                    <button
                                        class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseFeatures"
                                        aria-expanded="false"
                                        aria-controls="collapseFeatures">
                                        <i class="fas fa-magic text-primary me-2"></i>
                                        <strong>Smart Import Features</strong>
                                    </button>
                                </h2>
                                <div
                                    id="collapseFeatures"
                                    class="accordion-collapse collapse"
                                    aria-labelledby="headingFeatures"
                                    data-bs-parent="#importAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Flexible Column Names</h6>
                                                <small class="text-muted">
                                                    <strong>Date:</strong> postedOn, transaction_date, expense_date<br />
                                                    <strong>Amount:</strong> cost, price, total, value<br />
                                                    <strong>Restaurant:</strong> payee, vendor, merchant, location<br />
                                                    <strong>Category:</strong> usage_category, type<br />
                                                    <strong>Notes:</strong> description, memo, comment<br />
                                                    <strong>Tags:</strong> tags, label, labels
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Smart Processing</h6>
                                                <small class="text-muted">
                                                    • Multiple date formats (ISO, US, European, Excel)<br />
                                                    • Currency symbols and thousands separators<br />
                                                    • Duplicate detection and prevention<br />
                                                    • Restaurant matching and disambiguation<br />
                                                    • Hierarchical category mapping<br />
                                                    • Tag matching with auto-create
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Format Examples -->
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="headingExamples">
                                    <button
                                        class="accordion-button collapsed"
                                        type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapseExamples"
                                        aria-expanded="false"
                                        aria-controls="collapseExamples">
                                        <i class="fas fa-list-alt text-info me-2"></i>
                                        <strong>Format Examples</strong>
                                    </button>
                                </h2>
                                <div
                                    id="collapseExamples"
                                    class="accordion-collapse collapse"
                                    aria-labelledby="headingExamples"
                                    data-bs-parent="#importAccordion">
                                    <div class="accordion-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6>Valid Date Formats</h6>
                                                <code class="d-block">2025-09-15</code>
                                                <code class="d-block">9/15/2025</code>
                                                <code class="d-block">45230 (Excel serial)</code>
                                            </div>
                                            <div class="col-md-6">
                                                <h6>Valid Amount Formats</h6>
                                                <code class="d-block">24.77 (expense)</code>
                                                <code class="d-block">($15.50) (expense)</code>
                                                <code class="d-block">+$76.89 (reimbursement)</code>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <form
                        method="post"
                        enctype="multipart/form-data"
                        id="import-form"
                        class="needs-validation"
                        novalidate>
                        {{ form.hidden_tag() }}
                        <div class="mb-3">
                            <label for="file" class="form-label">Select CSV or JSON file</label>
                            {{ form.file(class_="form-control", accept=".csv,.json", id="file") }}
                            <div class="invalid-feedback">Please select a CSV or JSON file to upload.</div>
                            <div class="form-text">
                                Maximum file size: 5MB. Maximum rows: 2,000. CSV and JSON files are supported.
                            </div>
                        </div>

                        <!-- Upload progress (shown during file upload) -->
                        <div id="import-upload-progress" class="d-none mt-3" aria-live="polite">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted" id="import-upload-status">Uploading…</small>
                                <small class="text-muted" id="import-upload-percent">0%</small>
                            </div>
                            <div class="progress" role="progressbar" aria-label="Upload progress">
                                <div
                                    id="import-upload-bar"
                                    class="progress-bar progress-bar-striped progress-bar-animated"
                                    style="width: 0%"
                                    aria-valuenow="0"
                                    aria-valuemin="0"
                                    aria-valuemax="100"></div>
                            </div>
                        </div>
                        <div id="import-upload-error" class="alert alert-danger d-none mt-3" role="alert"></div>

                        <!-- Show form validation errors -->
                        {% if form.errors %}
                        <div class="alert alert-danger">
                            <h5 class="alert-heading">Form Validation Errors</h5>
                            <ul class="mb-0">
                                {% for field, errors in form.errors.items() %} {% for error in errors %}
                                <li> <strong>{{ field }}:</strong> {{ error }} </li>
                                {% endfor %} {% endfor %}
                            </ul>
                        </div>
                        {% endif %}

                        <!-- Import Summary (when available) -->
                        {% if import_summary %}
                        <div class="alert alert-info">
                            <h5 class="alert-heading"><i class="fas fa-info-circle me-2"></i>Import Summary</h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Processed:</strong> {{ import_summary.get('success_count', 0) +
                                    import_summary.get('error_count', 0) }} rows
                                </div>
                                <div class="col-md-3">
                                    <strong class="text-success">Imported:</strong> {{
                                    import_summary.get('success_count', 0) }}
                                </div>
                                <div class="col-md-3">
                                    <strong class="text-warning">Skipped:</strong> {{
                                    import_summary.get('skipped_count', 0) }}
                                </div>
                                <div class="col-md-3">
                                    <strong class="text-danger">Errors:</strong> {{ import_summary.get('error_count', 0)
                                    }}
                                </div>
                            </div>
                        </div>
                        {% endif %} {% if import_summary and import_summary.get('tag_summary') %}
                        <div class="alert alert-secondary">
                            <h5 class="alert-heading"><i class="fas fa-tags me-2"></i>Affected Tags</h5>
                            <div class="d-flex flex-wrap gap-2">
                                {% for tag in import_summary.get('tag_summary', []) %}
                                <span class="badge {% if tag.is_new %}bg-success{% else %}bg-secondary{% endif %}">
                                    {{ tag.name }} ({{ tag.count }}){% if tag.is_new %} new{% endif %}
                                </span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %} {% if import_summary and import_summary.get('restaurant_summary') %}
                        <div class="alert alert-light">
                            <h5 class="alert-heading"> <i class="fas fa-store me-2"></i>Affected Restaurants </h5>
                            <ul class="mb-0">
                                {% for restaurant in import_summary.get('restaurant_summary')[:10] %}
                                <li><small>{{ restaurant }}</small></li>
                                {% endfor %}
                            </ul>
                            {% if import_summary.get('restaurant_summary')|length > 10 %}
                            <small class="text-muted"
                                >... and {{ import_summary.get('restaurant_summary')|length - 10 }} more</small
                            >
                            {% endif %}
                        </div>
                        {% endif %} {% if import_summary and import_summary.get('expense_summary') %}
                        <div class="alert alert-light">
                            <h5 class="alert-heading"> <i class="fas fa-receipt me-2"></i>Affected Expenses </h5>
                            <ul class="mb-0">
                                {% for expense in import_summary.get('expense_summary') %}
                                <li>
                                    <small>
                                        {{ expense.date }} — {% if expense.amount is not none %}${{
                                        expense.amount|format_number(2) }}{% else %}N/A{% endif %} {% if
                                        expense.restaurant_name %} • {{ expense.restaurant_name }}{% endif %} {% if
                                        expense.meal_type %} • {{ expense.meal_type }}{% endif %} {% if expense.tags %}
                                        • Tags: {{ expense.tags }}{% endif %}
                                    </small>
                                </li>
                                {% endfor %}
                            </ul>
                            {% if import_summary.get('expense_summary_total', 0) >
                            import_summary.get('expense_summary')|length %}
                            <small class="text-muted"
                                >... and {{ import_summary.get('expense_summary_total', 0) -
                                import_summary.get('expense_summary')|length }} more</small
                            >
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Import Warnings (Duplicates) -->
                        {% if warnings %}
                        <div class="alert alert-warning">
                            <h5 class="alert-heading"><i class="fas fa-exclamation-circle me-2"></i>Import Warnings</h5>
                            <p class="mb-3">{{ warnings|length }} items were skipped during import:</p>
                            <div class="warning-list scrollable-container-md">
                                <ul class="mb-0">
                                    {% for warning in warnings %}
                                    <li class="mb-1"><small>{{ warning }}</small></li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Detailed Import Errors -->
                        {% if errors %}
                        <div class="alert alert-danger">
                            <h5 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Import Errors</h5>
                            <p class="mb-3"
                                >{{ errors|length }} errors occurred during import. Please fix these issues in your file
                                and try again:</p
                            >
                            <div class="error-list scrollable-container-lg">
                                <ul class="mb-0">
                                    {% for error in errors %}
                                    <li class="mb-1"><code>{{ error }}</code></li>
                                    {% endfor %}
                                </ul>
                            </div>

                            <!-- Common Error Help -->
                            <div class="mt-3 p-3 bg-light rounded">
                                <h6><i class="fas fa-lightbulb me-2"></i>Common Solutions:</h6>
                                <ul class="mb-0 small">
                                    <li
                                        ><strong>"Amount is required":</strong> Check that your amount column has data
                                        and is named correctly (amount, cost, price, etc.)</li
                                    >
                                    <li
                                        ><strong>"Date is required":</strong> Ensure your date column exists and uses
                                        supported formats (M/D/YYYY, YYYY-MM-DD)</li
                                    >
                                    <li
                                        ><strong>"Invalid amount format":</strong> Use formats like: 24.77, $24.77,
                                        (24.77), +$24.77</li
                                    >
                                    <li
                                        ><strong>"Invalid date format":</strong> Use: 8/30/2025, 2025-08-30, or similar
                                        supported formats</li
                                    >
                                    <li
                                        ><strong>"matches multiple existing restaurants":</strong> Add an address column
                                        to disambiguate restaurants with the same name</li
                                    >
                                    <li
                                        ><strong>"not found. Please provide an address":</strong> Add an address column
                                        to create new restaurant entries</li
                                    >
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                        <div class="d-flex gap-2">
                            {% if import_summary and import_summary.get('success_count', 0) > 0 %}
                            <!-- Show different buttons when import was partially successful -->
                            <a href="{{ url_for('expenses.list_expenses') }}" class="btn btn-success">
                                <i class="fas fa-check me-1"></i> View Imported Expenses
                            </a>
                            {{ form.submit(class_="btn btn-primary") }} {% else %}
                            <!-- Show normal submit when no import happened yet -->
                            {{ form.submit(class_="btn btn-primary") }}
                            <a href="{{ url_for('expenses.list_expenses') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i> Cancel
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %} {% block scripts %} {{ super() }}
<!-- Expense import form validation -->
<script src="{{ url_for('static', filename='js/pages/expense-import.js') }}"></script>
{% endblock scripts %}
