{% macro expense_form(form, expense=None, is_edit=false, timezone_display=None) %}
    <form id="expenseForm"
          method="post"
          enctype="multipart/form-data"
          novalidate
          action="{% if is_edit %}{{ url_for('expenses.edit_expense', expense_id=expense.id) }}{% else %}{{ url_for('expenses.add_expense', restaurant_id=request.view_args.get('restaurant_id') ) if request.view_args and request.view_args.get('restaurant_id') else url_for('expenses.add_expense') }}{% endif %}"
          data-ajax
          data-validate
          data-extension-safe="true">
        {% if form %}
            {{ form.hidden_tag() }}
        {% else %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}
        <!-- Hidden timezone field - populated by JavaScript -->
        <input type="hidden" id="browser_timezone" name="browser_timezone" value="UTC">
        <div id="formErrors" class="alert alert-danger d-none"></div>
        <div class="row mb-3">
            <div class="col-md-6">
                {{ form.restaurant_id.label(class="form-label") }}
                {{ form.restaurant_id(class_="form-select" + (' is-invalid' if form.restaurant_id.errors else '') ,
                **({'data-restaurant-id': expense.restaurant_id} if expense and expense.restaurant_id else {})
                ) }}
                {% if form.restaurant_id.errors %}<div class="invalid-feedback">{{ form.restaurant_id.errors[0] }}</div>{% endif %}
                <div id="restaurant-address-display" class="mt-2" style="display: none;"></div>
                <div class="form-text">
                    <a href="{{ url_for('restaurants.add_restaurant') }}">Add a new restaurant</a>
                </div>
            </div>
            <div class="col-md-6">
                {{ form.category_id.label(class="form-label") }}
                <select name="{{ form.category_id.name }}"
                        id="{{ form.category_id.id }}"
                        class="form-select{{ ' is-invalid' if form.category_id.errors else '' }}"
                        data-category-select>
                    {% for choice in form.category_id.choices %}
                        <option value="{{ choice[0] if choice[0] is not none else '' }}"
                                {% if form.category_id.data == choice[0] %}selected{% endif %}
                                {% if choice[0] is not none %}
                                    {% set cat_data = categories | selectattr('id', 'equalto', choice[0]) | first %}
                                    {% if cat_data %}data-color="{{ cat_data.color }}" data-icon="{{ cat_data.icon if cat_data.icon else '' }}"{% endif %}
                                {% endif %}>{{ choice[1] }}</option>
                    {% endfor %}
                </select>
                {% if form.category_id.errors %}<div class="invalid-feedback">{{ form.category_id.errors[0] }}</div>{% endif %}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                {{ form.date.label(class="form-label") }}
                {% set default_date = form.date.data.strftime('%Y-%m-%d') if form.date.data else '' %}
                <input type="date"
                       id="{{ form.date.id }}"
                       name="{{ form.date.name }}"
                       class="form-control{{ ' is-invalid' if form.date.errors else '' }}"
                       value="{{ default_date }}"
                       required>
                {% if form.date.errors %}<div class="invalid-feedback">{{ form.date.errors[0] }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    {{ form.time.label(class="form-label mb-0") }}
                    {% if timezone_display %}
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        <strong>{{ timezone_display }}</strong>
                    </small>
                    {% endif %}
                </div>
                {% set default_time = form.time.data.strftime('%H:%M') if form.time.data else '' %}
                <input type="time"
                       id="{{ form.time.id }}"
                       name="{{ form.time.name }}"
                       class="form-control{{ ' is-invalid' if form.time.errors else '' }}"
                       value="{{ default_time }}"
                       placeholder="Optional time (e.g., 14:30)">
                {% if form.time.errors %}<div class="invalid-feedback">{{ form.time.errors[0] }}</div>{% endif %}
                <div class="form-text">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Optional time in 24-hour format. If not specified, defaults to noon in your browser's timezone.
                    </small>
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                {{ form.amount.label(class="form-label") }}
                <div class="input-group">
                    <span class="input-group-text">$</span>
                    {{ form.amount(class_="form-control" + (' is-invalid' if form.amount.errors else '') ,
                    placeholder="0.00",
                    step="0.01",
                    min="0.01",
                    value=form.amount.data|string if form.amount.data is not none else ''
                    ) }}
                </div>
                <div class="form-text">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Enter amount in dollars and cents (e.g., 7.89 for $7.89)
                    </small>
                </div>
                {% if form.amount.errors %}<div class="invalid-feedback d-block">{{ form.amount.errors[0] }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                {{ form.meal_type.label(class="form-label") }}
                {{ form.meal_type(class="form-select" + (' is-invalid' if form.meal_type.errors else '') ) }}
                {% if form.meal_type.errors %}<div class="invalid-feedback">{{ form.meal_type.errors[0] }}</div>{% endif %}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                {{ form.order_type.label(class="form-label") }}
                {{ form.order_type(class="form-select" + (' is-invalid' if form.order_type.errors else '') ) }}
                {% if form.order_type.errors %}<div class="invalid-feedback">{{ form.order_type.errors[0] }}</div>{% endif %}
            </div>
            <div class="col-md-6">
                {{ form.party_size.label(class="form-label") }}
                {{ form.party_size(class="form-control" + (' is-invalid' if form.party_size.errors else '') ) }}
                {% if form.party_size.errors %}<div class="invalid-feedback">{{ form.party_size.errors[0] }}</div>{% endif %}
                <div class="form-text">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Number of people for this meal (optional - used to calculate price per person)
                    </small>
                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                {{ form.notes.label(class="form-label") }}
                {{ form.notes(class="form-control" + (' is-invalid' if form.notes.errors else '') ,
                placeholder="Brief description of the expense") }}
                {% if form.notes.errors %}<div class="invalid-feedback">{{ form.notes.errors[0] }}</div>{% endif %}
            </div>
        </div>

        <!-- Receipt Upload Section -->
        <div class="row mb-3">
            <div class="col-12">
                <label for="receipt_image" class="form-label">
                    <i class="fas fa-receipt me-1"></i>Receipt Image (Optional)
                </label>
                <div class="input-group">
                    <input type="file"
                           id="receipt_image"
                           name="receipt_image"
                           class="form-control"
                           accept="image/*,.pdf"
                           {% if expense and expense.receipt_image %}
                               data-existing-receipt="{{ get_receipt_url(expense.receipt_image) }}"
                           {% endif %}>
                    <button type="button"
                            class="btn btn-outline-secondary"
                            id="view-receipt-btn"
                            disabled
                            title="Preview receipt">
                        <i class="fas fa-eye me-1"></i>View
                    </button>
                    <button type="button"
                            class="btn btn-outline-primary"
                            id="process-receipt-btn"
                            disabled
                            title="Process receipt with OCR to extract data">
                        <i class="fas fa-magic me-1"></i>Process Receipt
                    </button>
                </div>
                <!-- Hidden field to track receipt deletion -->
                <input type="hidden" id="delete_receipt" name="delete_receipt" value="false">
                <div class="form-text">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Upload a photo of your receipt. Supported formats: JPG, PNG, GIF, PDF. Max size: 5MB.
                        {% if expense and expense.receipt_image %}
                            <br>
                            <div class="d-flex gap-2 mt-2">
                                <a href="{{ get_receipt_url(expense.receipt_image) }}" class="text-primary">
                                    <i class="fas fa-eye me-1"></i>View current receipt
                                </a>
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger"
                                        onclick="deleteReceipt()"
                                        title="Delete receipt">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        {% endif %}
                    </small>
                </div>
                <!-- OCR Processing Status -->
                <div id="ocr-processing-status" class="mt-2" style="display: none;">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-spinner fa-spin me-2"></i>
                        <span id="ocr-status-text">Processing receipt with OCR...</span>
                    </div>
                </div>
                <!-- Receipt Preview Modal -->
                <div class="modal fade" id="receiptPreviewModal" tabindex="-1" aria-labelledby="receiptPreviewModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="receiptPreviewModalLabel">
                                    <i class="fas fa-receipt me-2"></i>Receipt Preview
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body text-center">
                                <div id="receipt-preview-container">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Reconciliation Panel -->
                <div id="reconciliation-panel" class="mt-3" style="display: none;">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-check-circle me-2"></i>Receipt Reconciliation
                        </div>
                        <div class="card-body">
                            <p class="card-text">
                                <small>Compare the extracted data with your form entries:</small>
                            </p>
                            <div id="reconciliation-results"></div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-success" onclick="applyAllSuggestions()">
                                    <i class="fas fa-check-double me-1"></i>Apply All Suggestions
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="dismissReconciliation()">
                                    <i class="fas fa-times me-1"></i>Dismiss
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tags Section (shared tag-selector-widget structure with filter) -->
        <div class="row mb-3">
            <div class="col-12 tag-selector-widget">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    {{ form.tags.label(class="form-label mb-0") }}
                    <a href="#" id="manageTagsLink" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#tagEditorModal">
                        <i class="fas fa-cog me-1"></i>Manage Tags
                    </a>
                </div>
                <select id="tagsInput"
                       name="tags"
                       class="form-control"
                       multiple
                       placeholder="Type to add tags..."
                       {% if expense and expense.tags %}
                           data-existing-tags='{{ expense.tags|tags_to_dict|tojson|safe }}'
                       {% endif %}>
                </select>
                <div class="form-text mt-3" id="tags-help">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Click to select tags or type to create new ones. Selected tags appear as badges.
                    </small>
                </div>
                {% if form.tags.errors %}<div class="invalid-feedback">{{ form.tags.errors[0] }}</div>{% endif %}
            </div>
        </div>
        <div class="d-flex justify-content-between">
            {% if expense and expense.restaurant %}
                <a href="{{ url_for('restaurants.restaurant_details', restaurant_id=expense.restaurant.id) }}"
                   class="btn btn-secondary">Cancel</a>
            {% else %}
                <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Cancel</a>
            {% endif %}
            <button type="submit" class="btn btn-primary">{{ 'Update' if is_edit else 'Add' }} Expense</button>
        </div>
    </form>
{% endmacro %}
{% macro expense_scripts() %}
    <!-- Unified Error Handler already loaded in base template -->

    <!-- Expense Form CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/expense-form.css') }}">

    <!-- Tom Select CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css">
    <!-- Custom tag styling -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tag-select.css') }}">
    <!-- Dynamic user tag colors -->
    <link rel="stylesheet" href="{{ url_for('main.user_tag_css') }}">

    <!-- Address normalization utilities (must load before expense-form-handler) -->
    <script src="{{ url_for('static', filename='js/utils/address-utils.js') }}"></script>

    <!-- Expense form handler (handles form submission via Fetch API) -->
    <script type="module"
            src="{{ url_for('static', filename='js/pages/expense-form-handler.js') }}"></script>

    <!-- Tom Select JS -->
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

    <!-- Category dropdown enhancement -->
    <script type="module" src="{{ url_for('static', filename='js/components/category-dropdown.js') }}"></script>

    <!-- Tag Manager for modal functionality -->
    <script src="{{ url_for('static', filename='js/components/tag-manager.js') }}"></script>

    <!-- Tom Select initialization script -->
    <script src="{{ url_for('static', filename='js/utils/tag-select-init.js') }}"></script>

    <!-- Receipt deletion functionality -->
    <script>
        function deleteReceipt() {
            if (confirm('Are you sure you want to delete this receipt? This action cannot be undone.')) {
                // Set the hidden field to indicate deletion
                const deleteField = document.getElementById('delete_receipt');
                if (deleteField) {
                    deleteField.value = 'true';
                }

                // Clear the file input
                const fileInput = document.getElementById('receipt_image');
                if (fileInput) {
                    fileInput.value = '';
                }

                // Hide the receipt actions
                const receiptActions = document.querySelector('.d-flex.gap-2');
                if (receiptActions) {
                    receiptActions.style.display = 'none';
                }

                // Show processing message
                const formText = document.querySelector('.form-text');
                if (formText) {
                    const processingMsg = document.createElement('div');
                    processingMsg.className = 'alert alert-info alert-dismissible fade show mt-2';
                    processingMsg.innerHTML = `
                        <i class="fas fa-spinner fa-spin me-1"></i>Deleting receipt...
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    formText.appendChild(processingMsg);
                }

                // Auto-submit the form to delete the receipt immediately
                const form = document.querySelector('form');
                if (form) {
                    // Create a temporary submit button to trigger form submission
                    const submitBtn = document.createElement('button');
                    submitBtn.type = 'submit';
                    submitBtn.style.display = 'none';
                    form.appendChild(submitBtn);
                    submitBtn.click();
                    form.removeChild(submitBtn);
                }

                // Note: Toast will be shown by the backend after successful deletion
            }
        }

        // Show success toast for receipt uploads
        function showReceiptUploadSuccess() {
            showSuccessToast('Receipt uploaded successfully!');
        }

        // Show error toast for receipt uploads
        function showReceiptUploadError(message) {
            showErrorToast(`Failed to upload receipt: ${message}`);
        }
    </script>
{% endmacro %}
