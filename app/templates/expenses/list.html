{% extends "base.html" %}
{% from 'macros/tag_helpers.html' import tag_badge %}
{% from 'macros/badge_helpers.html' import cuisine_badge %}

{% block title %}Expenses - Meal Expense Tracker{% endblock %}

{% block styles %}
    <link href="{{ url_for('static', filename='css/components/navbar.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/components/unified-table.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/components/category-badges.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/tags.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/components/tag-badges.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/pages/expense-list.css') }}" rel="stylesheet" />
{% endblock styles %}

{% block scripts %}
{{ super() }}
    <!-- Tag badge styling -->
    <script src="{{ url_for('static', filename='js/components/tag-badge-styler.js') }}"></script>
    <!-- Table sorting functionality -->
    <script src="{{ url_for('static', filename='js/components/table-sorting.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/pages/expense-list.js') }}"></script>
{% endblock scripts %}

{% block content %}
    <main class="container-fluid py-4">

        <!-- Breadcrumb Navigation -->
        {% set breadcrumb_items = [ {'url': url_for('main.index'), 'title': 'Dashboard'}, {'title': 'Expenses'} ] %}
        {% include 'includes/breadcrumb.html' %}

        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
            <h1 class="h3 mb-0">
                <i class="fas fa-receipt text-primary me-2"></i>My Expenses
            </h1>
            <div class="d-flex gap-2 flex-wrap">
                <!-- Primary Actions -->
                <a href="{{ url_for('expenses.add_expense') }}" class="btn btn-primary" data-bs-toggle="tooltip" title="Add a new expense">
                    <i class="fas fa-plus me-2"></i>Add Expense
                </a>
                <!-- Data Management Dropdown -->
                <div class="dropdown">
                    <button
                        class="btn btn-outline-secondary dropdown-toggle"
                        type="button"
                        id="dataManagementDropdown"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="fas fa-database me-2"></i>Data Management
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dataManagementDropdown">
                        <li>
                            <a class="dropdown-item" href="{{ url_for('expenses.export_expenses', format='csv') }}">
                                <i class="fas fa-file-csv me-2"></i> Export as CSV
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('expenses.export_expenses', format='json') }}">
                                <i class="fas fa-file-code me-2"></i> Export as JSON
                            </a>
                        </li>
                        <li>
                            <hr class="dropdown-divider" />
                        </li>
                        <li>
                            <a class="dropdown-item" href="{{ url_for('expenses.import_expenses') }}">
                                <i class="fas fa-file-import me-2"></i> Import Expenses
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Search & Filter + View Toggle Row -->
        {% set active_filters_count = (1 if search else 0) + (1 if meal_type else 0) + (1 if category else 0) + (1 if start_date else 0) + (1 if end_date else 0) %}
        {% set show_filters = active_filters_count > 0 or request.args.get('filter_expanded') == '1' %}

        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <!-- Search & Filter Collapsible Button -->
            <div class="d-flex align-items-center">
                <button
                    class="btn btn-outline-primary d-flex align-items-center {% if active_filters_count %}border-primary{% endif %}"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#filterCollapse"
                    aria-expanded="{% if show_filters %}true{% else %}false{% endif %}"
                    aria-controls="filterCollapse"
                    data-tooltip="true"
                    title="Show search and filter options">
                    <i class="fas fa-filter me-2"></i>Search & Filter
                    {% if active_filters_count %}
                        <span class="badge bg-primary ms-2">{{ active_filters_count }}</span>
                    {% endif %}
                    <i class="fas {% if show_filters %}fa-chevron-up{% else %}fa-chevron-down{% endif %} ms-2"></i>
                </button>
                {% if active_filters_count %}
                    <span class="badge bg-secondary ms-2 d-none d-md-inline">{{ expenses|length }} result{{ 's' if expenses|length != 1 else '' }}</span>
                {% endif %}
            </div>

            <!-- View Toggle -->
            <div class="btn-group" role="group" aria-label="View Toggle">
                <input type="radio" class="btn-check" name="view-type" id="card-view" autocomplete="off" checked />
                <label class="btn btn-outline-primary" for="card-view" id="card-view-label" data-bs-toggle="tooltip" title="Card view - shows expenses in card format">
                    <i class="fas fa-th-large me-2"></i>Cards
                </label>
                <input type="radio" class="btn-check" name="view-type" id="table-view" autocomplete="off" />
                <label class="btn btn-outline-primary" for="table-view" id="table-view-label" data-bs-toggle="tooltip" title="Table view - shows expenses in table format">
                    <i class="fas fa-table me-2"></i>Table
                </label>
            </div>
        </div>

        <!-- Collapsible Filter Form -->
        <div class="collapse {% if show_filters %}show{% endif %} mb-4" id="filterCollapse">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                        <!-- First Row -->
                        <div class="col-md-6">
                            <label for="search" class="form-label">Search</label>
                            <input
                                type="text"
                                class="form-control"
                                id="search"
                                name="q"
                                value="{{ search }}"
                                placeholder="Search restaurants, categories, notes, or meal types" />
                        </div>
                        <div class="col-md-3">
                            <label for="meal_type" class="form-label">Meal Type</label>
                            <select class="form-control" id="meal_type" name="meal_type">
                                <option value="">All Meal Types</option>
                                {% for type in meal_types %}
                                    <option value="{{ type }}"{% if meal_type == type %} selected{% endif %}>{{ type.title() }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-control" id="category" name="category">
                                <option value="">All Categories</option>
                                {% for cat in categories %}
                                    <option value="{{ cat }}"{% if category == cat %} selected{% endif %}>{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Second Row -->
                        <div class="col-md-4">
                            <label for="start_date" class="form-label">From Date</label>
                            <input
                                type="date"
                                class="form-control"
                                id="start_date"
                                name="start_date"
                                value="{{ start_date if start_date and start_date != 'None' else '' }}" />
                        </div>
                        <div class="col-md-4">
                            <label for="end_date" class="form-label">To Date</label>
                            <input
                                type="date"
                                class="form-control"
                                id="end_date"
                                name="end_date"
                                value="{{ end_date if end_date and end_date != 'None' else '' }}" />
                        </div>
                        <div class="col-md-4 d-flex align-items-end gap-2">
                            <button type="submit" class="btn btn-primary flex-fill" aria-label="Apply filters">
                                <i class="fas fa-search me-2" aria-hidden="true"></i> Filter
                            </button>
                            <a href="{{ url_for('expenses.list_expenses') }}" class="btn btn-outline-secondary" aria-label="Clear all filters">
                                <i class="fas fa-times me-2" aria-hidden="true"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Pagination Controls -->
        {% if total_expenses > 0 %}
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <!-- Results Summary -->
                <div class="d-flex align-items-center">
                    <span class="text-muted">
                        {% if per_page == -1 %}
                            Showing all {{ total_expenses }} expense{{ 's' if total_expenses != 1 else '' }}
                        {% else %}
                            Showing {{ page * per_page - per_page + 1 }}-{{ (page * per_page if page * per_page <= total_expenses else total_expenses) }} of {{ total_expenses }} expense{{ 's' if total_expenses != 1 else '' }}
                            (Page {{ page }} of {{ total_pages }})
                        {% endif %}
                        {% if total_amount > 0 %}
                            (Total: ${{ "%.2f"|format(total_amount) }})
                        {% endif %}
                    </span>
                </div>

                <!-- Pagination Controls -->
                <div class="d-flex align-items-center gap-3">
                    <!-- Items per page selector -->
                    <div class="d-flex align-items-center">
                        <label for="per_page" class="form-label mb-0 me-2 small text-muted">Show:</label>
                        <select id="per_page" name="per_page" class="form-select form-select-sm border-0 bg-light per-page-select">
                            <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                            <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                            <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                            <option value="-1" {% if per_page == -1 %}selected{% endif %}>All</option>
                        </select>
                    </div>

                    <!-- Page navigation (only show if paginated) -->
                    {% if per_page != -1 and total_pages > 1 %}
                        <div class="btn-group" role="group" aria-label="Page navigation">
                            <!-- Previous page -->
                            {% if page > 1 %}
                                <a class="btn btn-outline-primary btn-sm" href="{{ url_for('expenses.list_expenses', page=page-1, per_page=per_page, q=search, meal_type=meal_type, category=category, start_date=start_date, end_date=end_date) }}" aria-label="Previous">
                                    <i class="fas fa-chevron-left me-1"></i><span class="d-none d-sm-inline">Previous</span>
                                </a>
                            {% else %}
                                <span class="btn btn-outline-secondary btn-sm" aria-label="Previous page not available" role="button" tabindex="-1">
                                    <i class="fas fa-chevron-left me-1"></i><span class="d-none d-sm-inline">Previous</span>
                                </span>
                            {% endif %}

                            <!-- Page numbers -->
                            {% for p in range(1, total_pages + 1) %}
                                {% if p == page %}
                                    <span class="btn btn-primary btn-sm" aria-label="Current page {{ p }}" role="button" tabindex="-1">{{ p }}</span>
                                {% elif p <= 3 or p > total_pages - 3 or (p >= page - 1 and p <= page + 1) %}
                                    <a class="btn btn-outline-primary btn-sm" href="{{ url_for('expenses.list_expenses', page=p, per_page=per_page, q=search, meal_type=meal_type, category=category, start_date=start_date, end_date=end_date) }}" aria-label="Go to page {{ p }}">{{ p }}</a>
                                {% elif p == 4 and page > 5 %}
                                    <span class="btn btn-outline-secondary btn-sm" aria-label="More pages available" role="button" tabindex="-1">...</span>
                                {% elif p == total_pages - 3 and page < total_pages - 4 %}
                                    <span class="btn btn-outline-secondary btn-sm" aria-label="More pages available" role="button" tabindex="-1">...</span>
                                {% endif %}
                            {% endfor %}

                            <!-- Next page -->
                            {% if page < total_pages %}
                                <a class="btn btn-outline-primary btn-sm" href="{{ url_for('expenses.list_expenses', page=page+1, per_page=per_page, q=search, meal_type=meal_type, category=category, start_date=start_date, end_date=end_date) }}" aria-label="Next">
                                    <span class="d-none d-sm-inline">Next</span><i class="fas fa-chevron-right ms-1"></i>
                                </a>
                            {% else %}
                                <span class="btn btn-outline-secondary btn-sm" aria-label="Next page not available" role="button" tabindex="-1">
                                    <span class="d-none d-sm-inline">Next</span><i class="fas fa-chevron-right ms-1"></i>
                                </span>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        {% if expenses %}
            <!-- Card View (responsive grid) -->
            <div id="card-view-container" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3 mb-4">
                {% for expense in expenses %}
                    <div class="col">
                        <div class="card h-100 shadow-sm">
                            <div class="card-body">
                                <!-- Top Row: Restaurant Info (Left 2/3) + Amount/Date (Right 1/3) -->
                                <div class="row mb-3">
                                    <div class="col-8">
                                        <div class="d-flex align-items-start">
                                            <!-- Restaurant Icon -->
                                            <div class="restaurant-icon me-2 flex-shrink-0">
                                                {% if expense.restaurant and expense.restaurant.website %}
                                                    <img
                                                        src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                                                        data-website="{{ expense.restaurant.website }}"
                                                        data-size="32"
                                                        alt="{{ expense.restaurant.name }} icon"
                                                        class="restaurant-favicon"
                                                        width="32"
                                                        height="32"
                                                        style="opacity: 0; transition: opacity 0.2s ease-in-out;"
                                                    />
                                                {% endif %}
                                                <i class="fas fa-utensils text-primary restaurant-fallback-icon{% if expense.restaurant and expense.restaurant.website %} d-none{% endif %}"></i>
                                            </div>

                                            <!-- Restaurant Name and Badges -->
                                            <div class="flex-grow-1">
                                                <h5 class="card-title mb-2">
                                                    <a href="{{ url_for('expenses.expense_details', expense_id=expense.id) }}"
                                                       class="text-decoration-none text-dark">
                                                        {% if expense.restaurant %}
                                                            {{ expense.restaurant.name }}
                                                        {% else %}
                                                            Unknown Restaurant
                                                        {% endif %}
                                                    </a>
                                                </h5>
                                                <!-- Cuisine and Service Level Badges (side by side) -->
                                                <div class="d-flex gap-2 mb-2">
                                                    {% from 'macros/badge_helpers.html' import cuisine_badge %}
                                                    {{ cuisine_badge(expense.restaurant.cuisine if expense.restaurant else None, size='sm') }}
                                                    {% if expense.restaurant and expense.restaurant.service_level %}
                                                        {% from 'macros/badge_helpers.html' import service_level_badge %}
                                                        {{ service_level_badge(expense.restaurant.service_level, size='sm') }}
                                                    {% endif %}
                                                </div>
                                                <!-- Meal and Order Type Badges (side by side) -->
                                                <div class="d-flex gap-2 mb-2">
                                                    {% if expense.meal_type %}
                                                        {% from 'macros/badge_helpers.html' import meal_type_badge %}
                                                        {{ meal_type_badge(expense.meal_type, size='sm') }}
                                                    {% endif %}
                                                    {% if expense.order_type %}
                                                        {% from 'macros/badge_helpers.html' import order_type_badge %}
                                                        {{ order_type_badge(expense.order_type, size='sm') }}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="fw-bold text-success fs-5 mb-2">
                                            ${{ "%.2f"|format(expense.amount) }}
                                        </div>
                                        <!-- Party Size and Price Per Person -->
                                        {% if expense.party_size and expense.party_size > 1 %}
                                            <div class="badge bg-info text-white mb-1 d-block">
                                                <i class="fas fa-users me-1"></i>{{ expense.party_size }} people
                                            </div>
                                            <div class="text-muted small">${{ "%.2f"|format(expense.price_per_person) }} / person</div>
                                        {% elif expense.party_size and expense.party_size == 1 %}
                                            <div class="badge bg-info text-white d-block">
                                                <i class="fas fa-user me-1"></i>1 person
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Middle Row: Tags + Note -->
                                {% if expense.tags or expense.notes %}
                                    <div class="row mb-1">
                                        <div class="col-8">
                                            {% if expense.tags %}
                                                <div class="d-flex align-items-start">
                                                    <i class="fas fa-tags me-2 text-muted mt-1"></i>
                                                    <div class="expense-tags">
                                                        {% for tag in expense.tags %}
                                                            {{ tag_badge(tag) }}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="col-4">
                                            {% if expense.notes %}
                                                <div class="text-muted small text-end">
                                                    <i class="fas fa-sticky-note text-warning me-1"
                                                       data-bs-toggle="tooltip"
                                                       data-bs-placement="top"
                                                       title="{{ expense.notes }}"></i>
                                                    <span class="fst-italic">Note</span>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}

                                <!-- Bottom Row: Location/Date (Left) + Actions (Right) -->
                                <div class="row pt-0 border-top">
                                    <div class="col-8">
                                        <div class="text-muted small">
                                            {% if expense.restaurant %}
                                                <i class="fas fa-map-marker-alt me-2"></i>
                                                {% if expense.restaurant.city and expense.restaurant.state %}
                                                    <span class="me-2">{{ expense.restaurant.city }}, {{ expense.restaurant.state }}</span>
                                                    {% if expense.restaurant.get_google_maps_url() %}
                                                        <a href="{{ expense.restaurant.get_google_maps_url() }}"
                                                           target="_blank"
                                                           class="text-decoration-none text-primary"
                                                           data-bs-toggle="tooltip"
                                                           title="View on Google Maps">
                                                            <i class="fas fa-map-marked-alt"></i>
                                                        </a>
                                                    {% endif %}
                                                {% elif expense.restaurant.city %}
                                                    {{ expense.restaurant.city }}
                                                {% elif expense.restaurant.address %}
                                                    {{ expense.restaurant.address|truncate(20, '...') }}
                                                {% else %}
                                                    Restaurant
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        <!-- Date (full format) -->
                                        <div class="text-muted small mt-1">
                                            <i class="far fa-calendar-alt me-1"></i>
                                            {{ expense.date|format_datetime_user_tz('%B %d, %Y') }}
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="d-flex gap-2 justify-content-end">
                                            <a href="{{ url_for('expenses.edit_expense', expense_id=expense.id) }}"
                                               class="btn btn-sm btn-outline-primary"
                                               data-bs-toggle="tooltip"
                                               title="Edit expense">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button"
                                                    class="btn btn-sm btn-outline-danger"
                                                    data-bs-toggle="modal"
                                                    data-bs-target="#deleteExpenseModal"
                                                    data-expense-id="{{ expense.id }}"
                                                    data-expense-description="{{ expense.restaurant.name if expense.restaurant else 'Unknown Restaurant' }}"
                                                    data-expense-amount="{{ '%.2f'|format(expense.amount) }}"
                                                    data-expense-date="{{ expense.date|format_date_user_tz('%B %d, %Y') }}"
                                                    data-tooltip="true"
                                                    title="Delete expense">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Table View (full width - break out with negative margins) -->
            <div id="table-view-container" class="d-none">
                <div class="restaurant-table-fullwidth">
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-sticky-frozen">
                                <table id="expenseTable" class="table table-hover align-middle expense-table mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th data-sort="true" data-sort-type="date">Date / Tags</th>
                                            <th data-sort="true" data-sort-type="text">Restaurant</th>
                                            <th data-sort="true" data-sort-type="text">Meal</th>
                                            <th data-sort="true" data-sort-type="text">Order</th>
                                            <th data-sort="true" data-sort-type="number" class="text-center">Party</th>
                                            <th data-sort="true" data-sort-type="currency" class="text-end">Price / Person</th>
                                            <th data-sort="true" data-sort-type="currency" class="text-end">Amount</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for expense in expenses %} {% include "expenses/_expense_table_row.html" %} {% endfor %}
                                    </tbody>
                                    <tfoot class="table-secondary">
                                        <tr>
                                            <td colspan="5" class="text-end fw-bold">Total:</td>
                                            <td class="fw-bold text-info amount-right">
                                                {% if avg_price_per_person %}
                                                    ${{ "%.2f"|format(avg_price_per_person) }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td class="fw-bold text-success amount-right">${{ "%.2f"|format(total_amount) }}</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-receipt fa-4x text-muted mb-3"></i>
                    <h3>No expenses found</h3>
                    <p class="text-muted">You haven't added any expenses yet.</p>
                    <a href="{{ url_for('expenses.add_expense') }}" class="btn btn-primary mt-2">
                        <i class="fas fa-plus me-2"></i> Add Your First Expense
                    </a>
                </div>
            </div>
        {% endif %}

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteExpenseModal" tabindex="-1" aria-labelledby="deleteExpenseModalLabel">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="deleteExpenseModalLabel">
                            <i class="fas fa-exclamation-triangle me-2"></i>Confirm Deletion
                        </h5>
                        <button
                            type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p> Are you sure you want to delete this expense? </p>
                        <div id="delete-expense-details" class="mt-2">
                            <!-- Details will be populated by JavaScript -->
                        </div>
                        <p class="text-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            This action cannot be undone.
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i> Cancel
                        </button>
                        <form id="delete-expense-form" method="post" action="">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash me-2"></i> Delete Expense
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </main>
{% endblock content %}
