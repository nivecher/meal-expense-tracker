{% extends "base.html" %}
{% from 'macros/category_helpers.html' import hex_to_rgb %}
{% from 'macros/cuisine_helpers.html' import cuisine_badge %}

{% block title %}Dashboard - Meal Expense Tracker{% endblock %}

{% block head_extra %}
<link href="{{ url_for('static', filename='css/components/dashboard.css') }}" rel="stylesheet" />
<link href="{{ url_for('static', filename='css/components/meal-type-badges.css') }}" rel="stylesheet" />
<link href="{{ url_for('static', filename='css/components/cuisine-badges.css') }}" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="dashboard">
<!-- Welcome Section -->
<section class="welcome-section mb-3">
        <div class="row align-items-center">
            <div class="col-xl-9 col-lg-8">
                <div class="welcome-content">
                    <h1 class="display-5 fw-bold mb-3">
                        <i class="fas fa-chart-line me-3 text-primary"></i>
                        <span class="text-primary">Welcome to</span><br>
                        <span class="text-dark">Meal Expense Tracker</span>
                    </h1>
<p class="lead text-muted mb-3">
                        Track your dining expenses, discover spending patterns, and manage your restaurant visits all in one place.
                        Get insights into your food budget and make informed decisions about your dining choices.
                    </p>
                    <div class="welcome-actions">
                        <!-- First row - Primary actions -->
                        <div class="d-flex flex-wrap gap-3 mb-3">
                            <a href="{{ url_for('expenses.add_expense') }}" class="btn btn-primary btn-lg">
                                <i class="fas fa-plus me-2"></i>Add Expense
                            </a>
                            <a href="{{ url_for('restaurants.add_restaurant') }}" class="btn btn-outline-primary btn-lg">
                                <i class="fas fa-utensils me-2"></i>Add Restaurant
                            </a>
                        </div>
                        <!-- Second row - View actions -->
                        <div class="d-flex flex-wrap gap-3">
                            <a href="{{ url_for('expenses.list_expenses') }}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-receipt me-2"></i>View Expenses
                            </a>
                            <a href="{{ url_for('restaurants.list_restaurants') }}" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-list me-2"></i>View Restaurants
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-lg-4 text-center">
                <div class="welcome-illustration">
                    <i class="fas fa-chart-pie dashboard-icon text-primary"></i>
                </div>
            </div>
        </div>
    </section>

<!-- Quick Stats Cards -->
<section class="stats-section mb-3">
        <div class="row g-4">
            <!-- Total Expenses -->
            <div class="col-6 col-md-3">
                <div class="stats-card h-100">
                    <div class="stats-icon">
                        <i class="fas fa-receipt text-primary"></i>
                    </div>
                    <div class="stats-content">
                        <div class="stats-value">{{ expense_stats.total_expenses or 0 }}</div>
                        <div class="stats-label">Total Expenses</div>
                    </div>
                </div>
            </div>

            <!-- Total Spent -->
            <div class="col-6 col-md-3">
                <div class="stats-card h-100">
                    <div class="stats-icon">
                        <i class="fas fa-dollar-sign text-success"></i>
                    </div>
                    <div class="stats-content">
                        <div class="stats-value">${{ "%.2f"|format(expense_stats.total_spent or 0) }}</div>
                        <div class="stats-label">Total Spent</div>
                    </div>
                </div>
            </div>

            <!-- Average Per Expense -->
            <div class="col-6 col-md-3">
                <div class="stats-card h-100">
                    <div class="stats-icon">
                        <i class="fas fa-calculator text-info"></i>
                    </div>
                    <div class="stats-content">
                        <div class="stats-value">${{ "%.2f"|format(expense_stats.avg_expense or 0) }}</div>
                        <div class="stats-label">Average Expense</div>
                    </div>
                </div>
            </div>

            <!-- Total Restaurants -->
            <div class="col-6 col-md-3">
                <div class="stats-card h-100">
                    <div class="stats-icon">
                        <i class="fas fa-utensils text-warning"></i>
                    </div>
                    <div class="stats-content">
                        <div class="stats-value">{{ restaurant_stats.total_restaurants or 0 }}</div>
                        <div class="stats-label">Restaurants</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

<!-- Main Content Grid -->
<div class="row g-4 mb-3">
        <!-- Recent Expenses -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2 text-primary"></i>Recent Expenses
                    </h5>
                    <a href="{{ url_for('expenses.list_expenses') }}" class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_expenses %}
                        <div class="recent-expenses-list">
                            {% for expense_row in recent_expenses %}
                                {% set expense = expense_row[0] %}
                                {% set restaurant_name = expense_row[1] %}
                                {% set restaurant_website = expense_row[2] %}
                                <a href="{{ url_for('expenses.expense_details', expense_id=expense.id) }}" class="expense-item-link">
                                    <div class="expense-item">
                                        <div class="expense-info">
                                            <div class="expense-restaurant d-flex align-items-center">
                                                <div class="restaurant-icon me-2 flex-shrink-0">
                                                    {% if restaurant_website %}
                                                        <img
                                                            src="https://t3.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url={{ restaurant_website }}&size=28"
                                                            alt="{{ restaurant_name }} icon"
                                                            class="restaurant-favicon"
                                                            width="28"
                                                            height="28"
                                                            loading="lazy"
                                                            onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"
                                                            onload="this.style.opacity='1';"
                                                            style="opacity: 0; transition: opacity 0.2s;"
                                                        />
                                                        <i class="fas fa-store text-muted restaurant-fallback-icon" style="display: none;"></i>
                                                    {% else %}
                                                        <i class="fas fa-store text-muted restaurant-fallback-icon"></i>
                                                    {% endif %}
                                                </div>
                                                {{ restaurant_name or 'Unknown Restaurant' }}
                                            </div>
                                            <div class="expense-details">
                                                <span class="expense-date text-muted">
                                                    {{ expense.date.strftime('%b %d, %Y') }}
                                                </span>
                                                {% if expense.meal_type %}
                                                    <span class="meal-type-badge {{ expense.meal_type|meal_type_css_class }}">
                                                        <i class="fas fa-{{ expense.meal_type|meal_type_icon }}"></i>
                                                        {{ expense.meal_type|title }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="expense-amount">
                                            ${{ "%.2f"|format(expense.amount) }}
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-receipt empty-icon text-muted mb-3"></i>
                            <h6 class="text-muted mb-3">No expenses recorded yet</h6>
                            <p class="text-muted mb-3">Start tracking your dining expenses to see them here.</p>
                            <a href="{{ url_for('expenses.add_expense') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add Your First Expense
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Top Restaurants -->
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy me-2 text-warning"></i>Top Restaurants
                    </h5>
                    <a href="{{ url_for('restaurants.list_restaurants') }}" class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    {% if top_restaurants %}
                        <div class="top-restaurants-list">
                            {% for restaurant in top_restaurants %}
                                <a href="{{ url_for('restaurants.restaurant_details', restaurant_id=restaurant[0]) }}" class="restaurant-item-link">
                                    <div class="restaurant-item">
                                        <div class="restaurant-info">
                                            <div class="restaurant-name d-flex align-items-center">
                                                <div class="restaurant-icon me-2 flex-shrink-0">
                                                                                                        {% if restaurant[2] %}
                                                        <img
                                                            src="https://t3.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url={{ restaurant[2] }}&size=28"
                                                            alt="{{ restaurant[1] }} icon"
                                                            class="restaurant-favicon"
                                                            width="28"
                                                            height="28"
                                                            loading="lazy"
                                                            onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';"
                                                            onload="this.style.opacity='1';"
                                                            style="opacity: 0; transition: opacity 0.2s;"
                                                        />
                                                        <i class="fas fa-store-alt text-muted restaurant-fallback-icon" style="display: none;"></i>
                                                    {% else %}
                                                        <i class="fas fa-store-alt text-muted restaurant-fallback-icon"></i>
                                                    {% endif %}
                                                </div>
                                                {{ restaurant[1] }}
                                            </div>
                                            <div class="restaurant-stats d-flex align-items-center gap-2">
                                                <span class="visit-count">{{ restaurant[4] }} visits</span>
                                                {% if restaurant[3] %}
                                                    {{ cuisine_badge(restaurant[3], compact=true) }}
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="restaurant-total">
                                            ${{ "%.2f"|format(restaurant[5]) }}
                                        </div>
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-utensils empty-icon text-muted mb-3"></i>
                            <h6 class="text-muted mb-3">No restaurants yet</h6>
                            <p class="text-muted mb-3">Add restaurants to track your favorite dining spots.</p>
                            <a href="{{ url_for('restaurants.add_restaurant') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add Restaurant
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

<!-- Quick Actions -->
<section class="quick-actions-section mb-3">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2 text-primary"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <!-- Top row: Expense actions -->
                <div class="row g-3 mb-3">
                    <div class="col-4 col-lg-4 col-md-4">
                        <a href="{{ url_for('expenses.add_expense') }}" class="quick-action-btn">
                            <i class="fas fa-plus mb-2"></i>
                            <div>Add Expense</div>
                        </a>
                    </div>
                    <div class="col-4 col-lg-4 col-md-4">
                        <a href="{{ url_for('expenses.list_expenses') }}" class="quick-action-btn">
                            <i class="fas fa-receipt mb-2"></i>
                            <div>View Expenses</div>
                        </a>
                    </div>
                    <div class="col-4 col-lg-4 col-md-4">
                        <a href="{{ url_for('expenses.import_expenses') }}" class="quick-action-btn">
                            <i class="fas fa-file-import mb-2"></i>
                            <div>Import Expenses</div>
                        </a>
                    </div>
                </div>
                <!-- Bottom row: Restaurant actions -->
                <div class="row g-3">
                    <div class="col-3 col-lg-3 col-md-3">
                        <a href="{{ url_for('restaurants.add_restaurant') }}" class="quick-action-btn">
                            <i class="fas fa-utensils mb-2"></i>
                            <div>Add Restaurant</div>
                        </a>
                    </div>
                    <div class="col-3 col-lg-3 col-md-3">
                        <a href="{{ url_for('restaurants.list_restaurants') }}" class="quick-action-btn">
                            <i class="fas fa-list mb-2"></i>
                            <div>View Restaurants</div>
                        </a>
                    </div>
                    <div class="col-3 col-lg-3 col-md-3">
                        <a href="{{ url_for('restaurants.import_restaurants') }}" class="quick-action-btn">
                            <i class="fas fa-file-upload mb-2"></i>
                            <div>Import Restaurants</div>
                        </a>
                    </div>
                    <div class="col-3 col-lg-3 col-md-3">
                        <a href="{{ url_for('restaurants.find_places') }}" class="quick-action-btn">
                            <i class="fas fa-search-location mb-2"></i>
                            <div>Find New Places</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

<!-- Navigation Guide -->
<section class="navigation-guide">
        <div class="card bg-light">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-compass me-2 text-primary"></i>Getting Started
                </h5>
                <div class="row g-4 mt-2">
                    <div class="col-md-4">
                        <div class="guide-step">
                            <div class="step-number">1</div>
                            <h6>Add Restaurants</h6>
                            <p class="text-muted">Start by adding your favorite restaurants or discover new ones using our restaurant search.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="guide-step">
                            <div class="step-number">2</div>
                            <h6>Track Expenses</h6>
                            <p class="text-muted">Log your dining expenses with details like meal type, amount, and notes for each visit.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="guide-step">
                            <div class="step-number">3</div>
                            <h6>Analyze Spending</h6>
                            <p class="text-muted">Review your spending patterns, discover your top restaurants, and manage your food budget.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</section>
</div>
{% endblock %}

{% block scripts %}
<script type="module" src="{{ url_for('static', filename='js/pages/dashboard.js') }}"></script>
{% endblock %}
