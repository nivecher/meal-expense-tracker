{% extends "base.html" %}

{% block title %}Edit Restaurant{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">{% if restaurant %}Edit{% else %}Add{% endif %} Restaurant</h2>
            </div>
            <div class="card-body">
                <form method="POST" class="needs-validation" novalidate>
                    <div class="mb-3">
                        <label for="name" class="form-label">Restaurant Name</label>
                        <input type="text" class="form-control" id="name" name="name" value="{{ restaurant.name if restaurant else '' }}" required>
                        <div class="invalid-feedback">Please enter a restaurant name.</div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <input type="text" class="form-control" id="address" name="address" value="{{ restaurant.address if restaurant else '' }}" required>
                        <div class="invalid-feedback">Please enter an address.</div>
                    </div>
                    <div class="mb-3">
                        <label for="chain" class="form-label">Restaurant Chain (Optional)</label>
                        <input type="text" class="form-control" id="chain" name="chain" value="{{ restaurant.chain if restaurant else '' }}">
                    </div>
                    <div class="mb-3">
                        <label for="category" class="form-label">Category (Optional)</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">Select a category</option>
                            <option value="restaurant" {% if restaurant and restaurant.category == 'restaurant' %}selected{% endif %}>Restaurant</option>
                            <option value="cafe" {% if restaurant and restaurant.category == 'cafe' %}selected{% endif %}>Cafe</option>
                            <option value="bar" {% if restaurant and restaurant.category == 'bar' %}selected{% endif %}>Bar</option>
                            <option value="bakery" {% if restaurant and restaurant.category == 'bakery' %}selected{% endif %}>Bakery</option>
                            <option value="food" {% if restaurant and restaurant.category == 'food' %}selected{% endif %}>Food</option>
                            <option value="meal_delivery" {% if restaurant and restaurant.category == 'meal_delivery' %}selected{% endif %}>Meal Delivery</option>
                            <option value="meal_takeaway" {% if restaurant and restaurant.category == 'meal_takeaway' %}selected{% endif %}>Meal Takeaway</option>
                            <option value="supermarket" {% if restaurant and restaurant.category == 'supermarket' %}selected{% endif %}>Supermarket</option>
                            <option value="grocery_or_supermarket" {% if restaurant and restaurant.category == 'grocery_or_supermarket' %}selected{% endif %}>Grocery Store</option>
                            <option value="convenience_store" {% if restaurant and restaurant.category == 'convenience_store' %}selected{% endif %}>Convenience Store</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3">{{ restaurant.description if restaurant else '' }}</textarea>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">Save Restaurant</button>
                        <a href="{{ url_for('restaurants') }}" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function initializePlacesAutocomplete() {
    try {
        const { Autocomplete } = await google.maps.importLibrary("places");
        
        const addressInput = document.getElementById('address');
        const nameInput = document.getElementById('name');
        const categorySelect = document.getElementById('category');
        const chainInput = document.getElementById('chain');
        
        const autocomplete = new Autocomplete(addressInput, {
            types: ['establishment'],
            fields: ['name', 'formatted_address', 'geometry', 'place_id', 'types']
        });

        // Handle place selection
        autocomplete.addListener('place_changed', function() {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                return;
            }

            // Update the address field with the formatted address
            addressInput.value = place.formatted_address;
            
            // Update the name field if it's empty
            if (!nameInput.value && place.name) {
                nameInput.value = place.name;
            }

            // Update category based on place types
            if (place.types) {
                const restaurantTypes = {
                    'restaurant': 'restaurant',
                    'cafe': 'cafe',
                    'bar': 'bar',
                    'bakery': 'bakery',
                    'food': 'food',
                    'meal_delivery': 'meal_delivery',
                    'meal_takeaway': 'meal_takeaway',
                    'supermarket': 'supermarket',
                    'grocery_or_supermarket': 'grocery_or_supermarket',
                    'convenience_store': 'convenience_store'
                };

                // Find the first matching type
                for (const type of place.types) {
                    if (restaurantTypes[type]) {
                        categorySelect.value = restaurantTypes[type];
                        break;
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error initializing Places Autocomplete:', error);
    }
}

// Initialize form validation
(function() {
    'use strict';
    const forms = document.querySelectorAll('.needs-validation');
    Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });
})();

// Initialize Places Autocomplete
initializePlacesAutocomplete();
</script>
{% endblock %} 